{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 76, "column": 0}, "map": {"version":3,"sources":["file:///Users/prestondinh/SICC/mvp/lib/e2b-executor.ts"],"sourcesContent":["import { Sandbox } from \"e2b\";\n\n// Skills content\nconst SKILLS = {\n  \"estate-document-analyzer\": {\n    \"SKILL.md\": `# Estate Document Analyzer Skill\n\nYou are an expert estate planning document analyzer. When given estate planning documents (wills, trusts, POAs, etc.), you:\n\n1. **Extract Key Information**:\n   - Document type and date\n   - Principal/grantor name\n   - Named parties (executors, trustees, agents, beneficiaries)\n   - Key provisions and terms\n\n2. **Identify Issues**:\n   - Missing signatures or witnesses\n   - Outdated information\n   - Ambiguous language\n   - Potential conflicts with other documents\n\n3. **Provide Recommendations**:\n   - Suggest updates needed\n   - Flag inconsistencies\n   - Note state-specific compliance issues\n\nOutput format: JSON with sections for extracted_info, issues, and recommendations.`\n  },\n  \"estate-goals-profiler\": {\n    \"SKILL.md\": `# Estate Goals Profiler Skill\n\nYou help clients articulate and prioritize their estate planning goals. You:\n\n1. **Identify Goals**:\n   - Asset protection\n   - Tax minimization\n   - Family provision\n   - Charitable giving\n   - Business succession\n   - Healthcare directives\n\n2. **Assess Priorities**:\n   - Rank goals by importance\n   - Identify potential conflicts\n   - Suggest compromise solutions\n\n3. **Recommend Documents**:\n   - Map goals to specific documents needed\n   - Prioritize document creation order\n\nOutput format: JSON with prioritized_goals, conflicts, and document_recommendations.`\n  },\n  \"financial-profile-classifier\": {\n    \"SKILL.md\": `# Financial Profile Classifier Skill\n\nYou analyze financial situations for estate planning purposes. You:\n\n1. **Classify Estate Size**:\n   - Simple (under $1M)\n   - Moderate ($1M - $5M)\n   - Complex ($5M - $12M)\n   - High Net Worth ($12M+)\n\n2. **Identify Tax Implications**:\n   - Federal estate tax exposure\n   - State estate/inheritance tax\n   - Gift tax considerations\n   - Generation-skipping tax\n\n3. **Recommend Strategies**:\n   - Basic will vs. living trust\n   - Irrevocable trust options\n   - Charitable planning\n   - Life insurance planning\n\nOutput format: JSON with classification, tax_exposure, and strategy_recommendations.`\n  },\n  \"us-estate-planning-analyzer\": {\n    \"SKILL.md\": `# US Estate Planning Analyzer Skill\n\nYou are an expert in US estate planning law. You analyze estate plans for:\n\n1. **Federal Compliance**:\n   - Estate tax exemption limits (current: $13.61M per person)\n   - Gift tax annual exclusion ($18,000 per recipient)\n   - Portability elections\n   - QTIP trust requirements\n\n2. **State-Specific Rules**:\n   - Community property vs. common law states\n   - State estate tax thresholds\n   - State inheritance taxes\n   - Homestead exemptions\n\n3. **Document Requirements**:\n   - Will execution requirements by state\n   - Trust formation rules\n   - POA statutory forms\n   - Healthcare directive compliance\n\n4. **Gap Analysis**:\n   - Missing essential documents\n   - Outdated provisions\n   - Beneficiary inconsistencies\n   - Tax optimization opportunities\n\nOutput format: JSON with compliance_status, state_specific_issues, gaps, and recommendations.`\n  }\n};\n\nconst OUTPUT_DIR = \"/home/user/generated\";\nconst SKILLS_DIR = \"/home/user/.claude/skills\";\n\nexport interface E2BExecuteResult {\n  success: boolean;\n  stdout?: string;\n  stderr?: string;\n  exitCode?: number;\n  fileContent?: string;\n  error?: string;\n  // Metadata from --output-format json\n  metadata?: {\n    numTurns?: number;\n    durationMs?: number;\n    totalCostUsd?: number;\n    sessionId?: string;\n    usage?: {\n      inputTokens?: number;\n      outputTokens?: number;\n      cacheReadInputTokens?: number;\n      cacheCreationInputTokens?: number;\n    };\n  };\n}\n\nexport interface E2BExecuteOptions {\n  prompt: string;\n  outputFile?: string;\n  timeoutMs?: number;\n  maxTurns?: number;           // Configurable max turns (default: 5)\n  enableWebSearch?: boolean;   // Enable web search capability\n  runType?: string;            // For logging/tracking\n}\n\n/**\n * Execute Claude Code in E2B sandbox\n * This is a shared function that can be called directly without HTTP\n */\nexport async function executeInE2B(options: E2BExecuteOptions): Promise<E2BExecuteResult> {\n  const { prompt, outputFile, timeoutMs = 240000, maxTurns = 5, enableWebSearch = false, runType } = options;\n\n  const E2B_API_KEY = process.env.E2B_API_KEY;\n  const ANTHROPIC_API_KEY = process.env.ANTHROPIC_API_KEY;\n\n  if (!E2B_API_KEY || !ANTHROPIC_API_KEY) {\n    return { success: false, error: \"API keys not configured\" };\n  }\n\n  // Create sandbox with very long timeout for comprehensive analysis\n  // Quality is the priority - allow up to 60 minutes for thorough analysis\n  const sandbox = await Sandbox.create(\"base\", {\n    timeoutMs: 3600000, // 60 minutes sandbox lifetime - quality over speed\n    apiKey: E2B_API_KEY,\n  });\n\n  try {\n    // Create directories\n    await sandbox.commands.run(`mkdir -p ${OUTPUT_DIR}`);\n    await sandbox.commands.run(`mkdir -p ${SKILLS_DIR}`);\n\n    // Inject skills\n    for (const [skillName, files] of Object.entries(SKILLS)) {\n      const skillDir = `${SKILLS_DIR}/${skillName}`;\n      await sandbox.commands.run(`mkdir -p \"${skillDir}\"`);\n      for (const [fileName, content] of Object.entries(files)) {\n        await sandbox.files.write(`${skillDir}/${fileName}`, content);\n      }\n    }\n\n    // Write the prompt to a file first - safer than embedding in shell script\n    await sandbox.files.write(\"/tmp/analysis_prompt.txt\", prompt);\n\n    // Create wrapper script that reads from the prompt file\n    const wrapperScript = `\n#!/bin/bash\n\ncd ${OUTPUT_DIR}\n\necho \"=== E2B Sandbox Debug Info ===\"\necho \"HOME: $HOME\"\necho \"PWD: $(pwd)\"\necho \"ANTHROPIC_API_KEY set: \\${ANTHROPIC_API_KEY:+yes}\"\necho \"ANTHROPIC_API_KEY length: \\${#ANTHROPIC_API_KEY}\"\n\n# Check prompt file\necho \"=== Prompt File ===\"\necho \"Prompt file exists: $(test -f /tmp/analysis_prompt.txt && echo yes || echo no)\"\necho \"Prompt file size: $(wc -c < /tmp/analysis_prompt.txt 2>/dev/null || echo 0) bytes\"\necho \"Prompt preview (first 200 chars):\"\nhead -c 200 /tmp/analysis_prompt.txt 2>/dev/null || echo \"(could not read)\"\necho \"\"\n\n# Install Claude Code CLI\necho \"=== Installing Claude Code CLI ===\"\nnpm install -g @anthropic-ai/claude-code 2>&1 || {\n    echo \"Failed to install claude-code globally, trying npx...\"\n    export USE_NPX=1\n}\n\n# Verify installation\nif [ \"\\${USE_NPX:-}\" != \"1\" ]; then\n    which claude || echo \"claude not found in PATH\"\n    claude --version 2>&1 || echo \"claude --version failed\"\nfi\n\necho \"=== Starting Claude Code ===\"\necho \"Working directory: $(pwd)\"\necho \"Max turns: ${maxTurns}\"\necho \"Run type: ${runType || 'general'}\"\necho \"Available skills:\"\nls -la $HOME/.claude/skills/ 2>/dev/null || echo \"(no skills)\"\n\n# Run Claude Code with stdin piping from prompt file\n# This is safer than embedding the prompt in the script\nCLAUDE_EXIT_CODE=0\nif [ \"\\${USE_NPX:-}\" = \"1\" ]; then\n    echo \"Running with npx...\"\n    cat /tmp/analysis_prompt.txt | npx -y @anthropic-ai/claude-code --print --dangerously-skip-permissions --output-format json --max-turns ${maxTurns} 2>&1\n    CLAUDE_EXIT_CODE=\\$?\nelse\n    echo \"Running with claude CLI...\"\n    cat /tmp/analysis_prompt.txt | claude --print --dangerously-skip-permissions --output-format json --max-turns ${maxTurns} 2>&1\n    CLAUDE_EXIT_CODE=\\$?\nfi\n\necho \"\"\necho \"=== Claude Code Finished (exit code: \\$CLAUDE_EXIT_CODE) ===\"\necho \"Generated files:\"\nls -la ${OUTPUT_DIR}/ 2>/dev/null || echo \"(none)\"\n\n# Also check if any json files were created anywhere\necho \"=== JSON files in sandbox ===\"\nfind /home/user -name \"*.json\" -type f 2>/dev/null || echo \"(none found)\"\n\n# Always exit 0 - we check for output file to determine success\nexit 0\n`;\n\n    await sandbox.files.write(\"/tmp/run_claude.sh\", wrapperScript);\n    await sandbox.commands.run(\"chmod +x /tmp/run_claude.sh\");\n\n    // Run Claude Code - use passed timeout (0 means use max timeout for comprehensive analysis)\n    const commandOptions: { envs: Record<string, string>; timeoutMs: number } = {\n      envs: {\n        ANTHROPIC_API_KEY,\n        HOME: \"/home/user\",\n        CI: \"true\",\n      },\n      // Quality is priority - allow up to 55 minutes per command (leaving 5 min buffer for sandbox lifetime)\n      // When timeoutMs is 0, use max. Otherwise use passed value or default 15 minutes.\n      timeoutMs: timeoutMs === 0 ? 3300000 : (timeoutMs || 900000),\n    };\n\n    const result = await sandbox.commands.run(\"bash /tmp/run_claude.sh\", commandOptions);\n\n    // Log full output for debugging\n    console.log(\"E2B execution completed:\", {\n      exitCode: result.exitCode,\n      stdoutLength: result.stdout?.length || 0,\n      stderrLength: result.stderr?.length || 0,\n    });\n\n    // Log full stdout to see what Claude Code returned\n    console.log(\"E2B FULL STDOUT:\", result.stdout);\n    if (result.stderr) {\n      console.log(\"E2B STDERR:\", result.stderr);\n    }\n\n    // Try to parse Claude Code's JSON output to see if there's an error\n    try {\n      const claudeOutputMatch = result.stdout.match(/\\{[\\s\\S]*\"is_error\"[\\s\\S]*\\}/);\n      if (claudeOutputMatch) {\n        const claudeOutput = JSON.parse(claudeOutputMatch[0]);\n        console.log(\"Claude Code output parsed:\", {\n          is_error: claudeOutput.is_error,\n          num_turns: claudeOutput.num_turns,\n          result: typeof claudeOutput.result === 'string'\n            ? claudeOutput.result.substring(0, 500)\n            : claudeOutput.result,\n        });\n\n        // If there's an error in Claude's output, report it\n        if (claudeOutput.is_error) {\n          console.error(\"Claude Code returned an error:\", claudeOutput.result);\n        }\n      }\n    } catch (parseErr) {\n      console.log(\"Could not parse Claude output as JSON\");\n    }\n\n    // Try to read output file if specified\n    let fileContent = \"\";\n    if (outputFile) {\n      const targetPath = `${OUTPUT_DIR}/${outputFile}`;\n      console.log(\"Attempting to read output file:\", targetPath);\n\n      try {\n        fileContent = await sandbox.files.read(targetPath);\n        console.log(\"Successfully read output file, length:\", fileContent.length);\n      } catch (readError) {\n        console.log(\"Failed to read output file directly:\", readError);\n\n        // Try to find any file with similar name\n        const listResult = await sandbox.commands.run(\n          `find ${OUTPUT_DIR} -type f 2>/dev/null || true`\n        );\n        const files = listResult.stdout.split(\"\\n\").filter((f: string) => f.trim());\n        console.log(\"Files found in output directory:\", files);\n\n        if (files.length > 0) {\n          try {\n            fileContent = await sandbox.files.read(files[0]);\n            console.log(\"Read first available file:\", files[0], \"length:\", fileContent.length);\n          } catch (fallbackError) {\n            console.log(\"Failed to read fallback file:\", fallbackError);\n          }\n        }\n      }\n    }\n\n    // Extract metadata from JSON output (--output-format json)\n    let metadata: E2BExecuteResult[\"metadata\"];\n    try {\n      const jsonMatch = result.stdout.match(/\\{[\\s\\S]*\"num_turns\"[\\s\\S]*\\}/);\n      if (jsonMatch) {\n        const parsed = JSON.parse(jsonMatch[0]);\n        metadata = {\n          numTurns: parsed.num_turns,\n          durationMs: parsed.duration_ms,\n          totalCostUsd: parsed.total_cost_usd,\n          sessionId: parsed.session_id,\n          usage: parsed.usage ? {\n            inputTokens: parsed.usage.input_tokens,\n            outputTokens: parsed.usage.output_tokens,\n            cacheReadInputTokens: parsed.usage.cache_read_input_tokens,\n            cacheCreationInputTokens: parsed.usage.cache_creation_input_tokens,\n          } : undefined,\n        };\n      }\n    } catch {\n      // Metadata extraction is best-effort, don't fail if it doesn't work\n    }\n\n    return {\n      success: true,\n      stdout: result.stdout,\n      stderr: result.stderr,\n      exitCode: result.exitCode,\n      fileContent,\n      metadata,\n    };\n  } finally {\n    await sandbox.kill();\n  }\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 391, "column": 0}, "map": {"version":3,"sources":["file:///Users/prestondinh/SICC/mvp/app/api/gap-analysis/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\nimport { executeInE2B } from \"@/lib/e2b-executor\";\n\n// Extend Vercel function timeout (comprehensive analysis needs time)\nexport const maxDuration = 600;\n\ninterface IntakeData {\n  estatePlan: { stateOfResidence?: string };\n  personal?: { data: string };\n  family?: { data: string };\n  assets?: { data: string };\n  existingDocuments?: { data: string };\n  goals?: { data: string };\n  beneficiaryDesignations?: BeneficiaryDesignation[];\n}\n\ninterface BeneficiaryDesignation {\n  assetType: string;\n  assetName: string;\n  institution?: string;\n  estimatedValue?: string;\n  primaryBeneficiaryName: string;\n  primaryBeneficiaryRelationship?: string;\n  primaryBeneficiaryPercentage?: number;\n  contingentBeneficiaryName?: string;\n  contingentBeneficiaryRelationship?: string;\n  contingentBeneficiaryPercentage?: number;\n  lastReviewedDate?: string;\n  notes?: string;\n}\n\ninterface ParsedIntake {\n  state: string;\n  personal: Record<string, unknown>;\n  family: Record<string, unknown>;\n  assets: Record<string, unknown>;\n  existingDocs: Record<string, unknown>;\n  goals: Record<string, unknown>;\n  beneficiaries: BeneficiaryDesignation[];\n}\n\nfunction parseIntakeData(intakeData: IntakeData): ParsedIntake {\n  const state = intakeData.estatePlan?.stateOfResidence || \"Unknown\";\n  let personal = {};\n  let family = {};\n  let assets = {};\n  let existingDocs = {};\n  let goals = {};\n\n  try {\n    if (intakeData.personal?.data) personal = JSON.parse(intakeData.personal.data);\n    if (intakeData.family?.data) family = JSON.parse(intakeData.family.data);\n    if (intakeData.assets?.data) assets = JSON.parse(intakeData.assets.data);\n    if (intakeData.existingDocuments?.data) existingDocs = JSON.parse(intakeData.existingDocuments.data);\n    if (intakeData.goals?.data) goals = JSON.parse(intakeData.goals.data);\n  } catch (e) {\n    console.error(\"Error parsing intake data:\", e);\n  }\n\n  return {\n    state,\n    personal,\n    family,\n    assets,\n    existingDocs,\n    goals,\n    beneficiaries: intakeData.beneficiaryDesignations || [],\n  };\n}\n\n// Helper to normalize yes/no/true/false to boolean\nfunction toBool(value: unknown): boolean {\n  if (typeof value === 'boolean') return value;\n  if (typeof value === 'string') {\n    const lower = value.toLowerCase();\n    return lower === 'yes' || lower === 'true' || lower === '1';\n  }\n  return !!value;\n}\n\n// Helper to get parsed client info for prompts\nfunction getClientContext(parsed: ParsedIntake): {\n  hasWill: boolean;\n  hasTrust: boolean;\n  hasPOAFinancial: boolean;\n  hasPOAHealthcare: boolean;\n  hasHealthcareDirective: boolean;\n  hasMinorChildren: boolean;\n  estimatedValue: number;\n  isMarried: boolean;\n  age: number;\n  spouseAge: number;\n  numberOfChildren: number;\n  hasBusinessInterests: boolean;\n  hasRealEstate: boolean;\n  hasRetirementAccounts: boolean;\n} {\n  const existingDocs = parsed.existingDocs as Record<string, unknown>;\n  const hasWill = toBool(existingDocs?.hasWill);\n  const hasTrust = toBool(existingDocs?.hasTrust);\n  const hasPOAFinancial = toBool(existingDocs?.hasPOAFinancial);\n  const hasPOAHealthcare = toBool(existingDocs?.hasPOAHealthcare);\n  const hasHealthcareDirective = toBool(existingDocs?.hasHealthcareDirective);\n\n  const familyData = parsed.family as Record<string, unknown>;\n  const children = (familyData?.children as Array<{ isMinor?: boolean }>) || [];\n  const hasMinorChildren = children.some(c => c.isMinor);\n  const numberOfChildren = children.length;\n\n  let estimatedValue = 0;\n  const assetsData = parsed.assets as Record<string, unknown>;\n  const rawValue = assetsData?.estimatedTotalValue || assetsData?.totalEstateValue;\n  if (typeof rawValue === 'number') {\n    estimatedValue = rawValue;\n  } else if (typeof rawValue === 'string') {\n    const valueMap: Record<string, number> = {\n      'under_100k': 50000, '100k_500k': 300000, '500k_1m': 750000,\n      '1m_2m': 1500000, '2m_5m': 3500000, '5m_plus': 7500000\n    };\n    estimatedValue = valueMap[rawValue] || parseInt(rawValue.replace(/[^0-9]/g, '')) || 0;\n  }\n\n  const personalData = parsed.personal as Record<string, unknown>;\n  const isMarried = personalData?.maritalStatus === \"married\";\n  const age = typeof personalData?.age === 'number' ? personalData.age : 0;\n  const spouseAge = typeof personalData?.spouseAge === 'number' ? personalData.spouseAge : 0;\n\n  const hasBusinessInterests = toBool(assetsData?.hasBusinessInterests) || toBool(assetsData?.ownsBusinessInterest);\n  const hasRealEstate = toBool(assetsData?.hasRealEstate) || (assetsData?.realEstateProperties as unknown[])?.length > 0;\n  const hasRetirementAccounts = toBool(assetsData?.hasRetirementAccounts) || (assetsData?.retirementAccounts as unknown[])?.length > 0;\n\n  return {\n    hasWill, hasTrust, hasPOAFinancial, hasPOAHealthcare, hasHealthcareDirective,\n    hasMinorChildren, estimatedValue, isMarried, age, spouseAge, numberOfChildren,\n    hasBusinessInterests, hasRealEstate, hasRetirementAccounts\n  };\n}\n\n// Build comprehensive context accumulator\nfunction buildContextAccumulator(parsed: ParsedIntake, ctx: ReturnType<typeof getClientContext>): string {\n  const personalData = parsed.personal as Record<string, unknown>;\n  const familyData = parsed.family as Record<string, unknown>;\n  const assetsData = parsed.assets as Record<string, unknown>;\n  const goalsData = parsed.goals as Record<string, unknown>;\n\n  return `\n# ESTATE PLANNING CONTEXT ACCUMULATOR\n\n## 1. IDENTITY & LIFE STAGE\n- **Full Name:** ${personalData?.firstName || 'Unknown'} ${personalData?.lastName || ''}\n- **Age:** ${ctx.age || 'Unknown'} years old\n- **State of Residence:** ${parsed.state}\n- **Marital Status:** ${ctx.isMarried ? 'Married' : personalData?.maritalStatus || 'Unknown'}\n${ctx.isMarried ? `- **Spouse Age:** ${ctx.spouseAge || 'Unknown'}` : ''}\n- **Life Stage Assessment:** ${\n  ctx.age >= 70 ? 'Late retirement - focus on legacy, incapacity planning, and potential long-term care' :\n  ctx.age >= 60 ? 'Pre-retirement/early retirement - estate tax planning window, beneficiary optimization' :\n  ctx.age >= 45 ? 'Peak earning years - asset protection, education funding, retirement planning' :\n  ctx.age >= 30 ? 'Family building years - minor children protection, insurance needs' :\n  'Early career - foundational documents needed'\n}\n\n## 2. FAMILY STRUCTURE\n- **Children:** ${ctx.numberOfChildren} ${ctx.numberOfChildren === 1 ? 'child' : 'children'}\n- **Minor Children:** ${ctx.hasMinorChildren ? 'YES - Guardian nomination critical' : 'No'}\n- **Named Guardian:** ${familyData?.guardian || 'NOT SPECIFIED'}\n- **Family Complexity Indicators:**\n  ${familyData?.isBlendedFamily ? '  - ‚ö†Ô∏è BLENDED FAMILY - requires careful beneficiary planning' : ''}\n  ${familyData?.hasSpecialNeedsDependent ? '  - ‚ö†Ô∏è SPECIAL NEEDS DEPENDENT - SNT consideration required' : ''}\n  ${familyData?.hasEstrangedRelatives ? '  - ‚ö†Ô∏è ESTRANGED RELATIVES - disinheritance provisions needed' : ''}\n  ${!familyData?.isBlendedFamily && !familyData?.hasSpecialNeedsDependent ? '  - Standard family structure' : ''}\n\n## 3. FINANCIAL NARRATIVE\n- **Estimated Total Estate Value:** $${ctx.estimatedValue.toLocaleString()}\n- **Estate Size Category:** ${\n  ctx.estimatedValue >= 13610000 ? 'TAXABLE ESTATE (exceeds 2024 federal exemption of $13.61M)' :\n  ctx.estimatedValue >= 5000000 ? 'LARGE ESTATE - tax planning critical before 2026 sunset' :\n  ctx.estimatedValue >= 1000000 ? 'SUBSTANTIAL ESTATE - probate avoidance valuable' :\n  ctx.estimatedValue >= 500000 ? 'MODERATE ESTATE - basic planning essential' :\n  'MODEST ESTATE - foundational documents needed'\n}\n- **Asset Composition:**\n  - Real Estate: ${ctx.hasRealEstate ? 'YES' : 'No'}\n  - Business Interests: ${ctx.hasBusinessInterests ? 'YES - succession planning needed' : 'No'}\n  - Retirement Accounts: ${ctx.hasRetirementAccounts ? 'YES - beneficiary designations critical' : 'No'}\n\n## 4. CURRENT DOCUMENT STATUS\n| Document | Status | Risk Level |\n|----------|--------|------------|\n| Last Will & Testament | ${ctx.hasWill ? '‚úÖ EXISTS' : '‚ùå MISSING'} | ${ctx.hasWill ? 'Low' : 'CRITICAL'} |\n| Revocable Living Trust | ${ctx.hasTrust ? '‚úÖ EXISTS' : '‚ùå MISSING'} | ${ctx.hasTrust || ctx.estimatedValue < 500000 ? 'Low' : 'HIGH'} |\n| Financial Power of Attorney | ${ctx.hasPOAFinancial ? '‚úÖ EXISTS' : '‚ùå MISSING'} | ${ctx.hasPOAFinancial ? 'Low' : 'CRITICAL'} |\n| Healthcare Power of Attorney | ${ctx.hasPOAHealthcare ? '‚úÖ EXISTS' : '‚ùå MISSING'} | ${ctx.hasPOAHealthcare ? 'Low' : 'CRITICAL'} |\n| Healthcare Directive/Living Will | ${ctx.hasHealthcareDirective ? '‚úÖ EXISTS' : '‚ùå MISSING'} | ${ctx.hasHealthcareDirective ? 'Low' : 'HIGH'} |\n\n## 5. STATED GOALS\n${JSON.stringify(goalsData, null, 2)}\n\n## 6. BENEFICIARY DESIGNATIONS\n${parsed.beneficiaries.length > 0 ? parsed.beneficiaries.map(b =>\n  `- **${b.assetName}** (${b.assetType}): Primary: ${b.primaryBeneficiaryName} (${b.primaryBeneficiaryPercentage || 100}%)${b.contingentBeneficiaryName ? `, Contingent: ${b.contingentBeneficiaryName}` : ''}`\n).join('\\n') : 'No beneficiary designations tracked - THIS IS A GAP'}\n\n## 7. RISK INDICATORS\n${ctx.hasBusinessInterests ? '- üî¥ Business succession risk - what happens to business at death/incapacity?' : ''}\n${ctx.hasMinorChildren && !familyData?.guardian ? '- üî¥ No guardian nominated for minor children' : ''}\n${ctx.estimatedValue > 1000000 && !ctx.hasTrust ? '- üü† No trust for $1M+ estate - probate exposure' : ''}\n${!ctx.hasPOAFinancial ? '- üî¥ No financial POA - incapacity crisis risk' : ''}\n${!ctx.hasPOAHealthcare ? '- üî¥ No healthcare POA - medical decision crisis risk' : ''}\n${ctx.isMarried && ctx.spouseAge && Math.abs(ctx.age - ctx.spouseAge) > 10 ? '- üü† Significant age gap between spouses - survivorship planning important' : ''}\n`;\n}\n\n// Build a QUICK analysis prompt - faster, essential findings only\nfunction buildQuickAnalysisPrompt(parsed: ParsedIntake): string {\n  const ctx = getClientContext(parsed);\n\n  return `You are an estate planning attorney reviewing a client's situation in ${parsed.state}.\n\n## CLIENT SUMMARY\n- State: ${parsed.state}\n- Marital Status: ${ctx.isMarried ? 'Married' : 'Single'}\n- Children: ${ctx.numberOfChildren} ${ctx.hasMinorChildren ? '(has minors)' : ''}\n- Estimated Estate Value: $${ctx.estimatedValue.toLocaleString()}\n- Has Will: ${ctx.hasWill ? 'Yes' : 'NO'}\n- Has Trust: ${ctx.hasTrust ? 'Yes' : 'NO'}\n- Has Financial POA: ${ctx.hasPOAFinancial ? 'Yes' : 'NO'}\n- Has Healthcare POA: ${ctx.hasPOAHealthcare ? 'Yes' : 'NO'}\n- Has Healthcare Directive: ${ctx.hasHealthcareDirective ? 'Yes' : 'NO'}\n- Has Business: ${ctx.hasBusinessInterests ? 'Yes' : 'No'}\n- Has Real Estate: ${ctx.hasRealEstate ? 'Yes' : 'No'}\n- Has Retirement Accounts: ${ctx.hasRetirementAccounts ? 'Yes' : 'No'}\n\n## ADDITIONAL DATA\n${JSON.stringify({ goals: parsed.goals, beneficiaries: parsed.beneficiaries }, null, 2)}\n\n---\n\n## TASK\nAnalyze this estate planning situation and write a JSON file to /home/user/generated/analysis.json with this structure:\n\n{\n  \"score\": <0-100, deduct: no will -15, no trust with $500K+ -10, no POAs -10 each, no directive -5>,\n  \"overallScore\": {\n    \"score\": <same as above>,\n    \"grade\": \"<A/B/C/D/F>\",\n    \"summary\": \"<2 sentence assessment>\"\n  },\n  \"executiveSummary\": {\n    \"oneLineSummary\": \"<key insight>\",\n    \"criticalIssues\": [\"<issue 1>\", \"<issue 2>\"],\n    \"immediateActions\": [\"<action 1>\", \"<action 2>\"]\n  },\n  \"missingDocuments\": [\n    {\n      \"document\": \"<name>\",\n      \"priority\": \"<critical/high/medium>\",\n      \"reason\": \"<why needed for THIS client>\",\n      \"consequences\": \"<what happens without it>\"\n    }\n  ],\n  \"outdatedDocuments\": [\n    {\"document\": \"<name>\", \"issue\": \"<problem>\", \"risk\": \"<risk>\", \"recommendation\": \"<action>\"}\n  ],\n  \"inconsistencies\": [\n    {\"type\": \"<type>\", \"severity\": \"<level>\", \"issue\": \"<description>\", \"resolution\": \"<fix>\"}\n  ],\n  \"financialExposure\": {\n    \"estimatedProbateCost\": {\"low\": <number>, \"high\": <number>},\n    \"estimatedEstateTax\": {\"federal\": <number>, \"state\": <number>}\n  },\n  \"stateSpecificNotes\": [\n    {\"topic\": \"<topic>\", \"rule\": \"<${parsed.state} rule>\", \"impact\": \"<effect>\", \"action\": \"<recommendation>\"}\n  ],\n  \"recommendations\": [\n    {\n      \"rank\": <1-5>,\n      \"action\": \"<specific recommendation>\",\n      \"category\": \"<documents/tax/beneficiaries>\",\n      \"priority\": \"<critical/high/medium>\",\n      \"timeline\": \"<immediate/30-days/90-days>\",\n      \"estimatedCost\": {\"low\": <number>, \"high\": <number>}\n    }\n  ],\n  \"scoreBreakdown\": {\n    \"startingScore\": 100,\n    \"deductions\": [\n      {\"reason\": \"<what's missing/wrong>\", \"points\": <number deducted>, \"category\": \"<documents/planning/beneficiaries>\"}\n    ],\n    \"finalScore\": <calculated score>,\n    \"summary\": \"<1 sentence explaining the score>\"\n  }\n}\n\nFocus on the MOST IMPORTANT findings. Be concise. Write the JSON now.`;\n}\n\n// Build the comprehensive deep analysis prompt (for multi-phase mode)\nfunction buildDeepAnalysisPrompt(parsed: ParsedIntake): string {\n  const ctx = getClientContext(parsed);\n  const contextAccumulator = buildContextAccumulator(parsed, ctx);\n\n  return `You are a senior estate planning attorney with 25+ years of experience in ${parsed.state}. You are conducting a thorough gap analysis that will be as valuable as a $500/hour consultation.\n\n${contextAccumulator}\n\n## RAW CLIENT DATA\n${JSON.stringify({ personal: parsed.personal, family: parsed.family, assets: parsed.assets, existingDocs: parsed.existingDocs, goals: parsed.goals }, null, 2)}\n\n---\n\n# DEEP ANALYSIS PROTOCOL\n\n## PHASE 1: PRE-ANALYSIS REASONING (Think through before writing output)\n\n### What makes this situation UNIQUE?\nConsider: age, family structure, asset composition, state of residence, stated goals, existing documents\n\n### What's the WORST thing that could happen?\nFor this specific client, enumerate the top 3 catastrophic scenarios given their current documents/situation.\n\n### What would an experienced attorney notice IMMEDIATELY?\nFlag obvious issues a professional would spot in 30 seconds of reviewing this case.\n\n### What would they notice after 30 MINUTES of review?\nDeeper issues requiring synthesis across documents, goals, and circumstances.\n\n### What's the $50,000 insight?\nThe single most valuable finding that justifies professional analysis for THIS client.\n\n---\n\n## PHASE 2: MULTI-LAYER GAP ANALYSIS\n\nAnalyze EACH of these 6 layers:\n\n### Layer 1: EXISTENCE GAPS\n- What essential documents are COMPLETELY MISSING?\n- What provisions are ABSENT from existing documents?\n- What beneficiary designations are EMPTY or DEFAULT?\n\n### Layer 2: ALIGNMENT GAPS\n- Where do documents CONTRADICT stated goals?\n- Where do documents CONTRADICT each other?\n- Where do beneficiary designations CONTRADICT wills/trusts?\n\n### Layer 3: OPTIMIZATION GAPS\n- What tax strategies are AVAILABLE but unused?\n- What estate planning techniques would benefit this client?\n- What's the COST of current structure vs. optimal?\n\n### Layer 4: RESILIENCE GAPS (Model each scenario)\n- What happens if primary income earner dies tomorrow?\n- What happens if both spouses die in common accident?\n- What happens if client becomes incapacitated?\n- What happens if a child divorces after inheriting?\n- What happens if a beneficiary predeceases?\n- What happens if federal estate tax exemption sunsets in 2026?\n\n### Layer 5: EXECUTION GAPS\n- Are documents properly executed for ${parsed.state}?\n- Are assets properly titled to work with the estate plan?\n- Are fiduciaries able and willing to serve?\n- Is the plan discoverable in an emergency?\n\n### Layer 6: TEMPORAL GAPS\n- What life events should trigger plan review?\n- What legal deadlines exist (tax elections, Medicaid lookback)?\n- How old are existing documents? Are they stale?\n\n---\n\n## PHASE 3: OUTPUT GENERATION\n\nWrite a JSON file to /home/user/generated/analysis.json with this ENHANCED structure:\n\n{\n  \"score\": <number 0-100>,\n  \"overallScore\": {\n    \"score\": <number 0-100>,\n    \"grade\": \"<A/B/C/D/F>\",\n    \"summary\": \"<2-3 sentence personalized assessment for THIS client>\"\n  },\n\n  \"preAnalysisInsights\": {\n    \"uniqueFactors\": [\"<what makes this case unique>\", \"...\"],\n    \"worstCaseScenarios\": [\n      {\n        \"scenario\": \"<description>\",\n        \"likelihood\": \"<low/medium/high>\",\n        \"financialImpact\": \"<dollar estimate>\",\n        \"currentProtection\": \"<none/partial/full>\"\n      }\n    ],\n    \"immediateRedFlags\": [\"<obvious issue 1>\", \"<obvious issue 2>\"],\n    \"deeperInsights\": [\"<synthesis insight 1>\", \"<synthesis insight 2>\"],\n    \"keyInsight\": \"<the single most valuable finding - the $50,000 insight>\"\n  },\n\n  \"missingDocuments\": [\n    {\n      \"document\": \"<full document name>\",\n      \"priority\": \"<critical/high/medium/low>\",\n      \"reason\": \"<2-3 sentences explaining why essential for THIS client specifically>\",\n      \"consequences\": \"<specific real-world consequences if not addressed - be concrete>\",\n      \"stateRequirements\": \"<${parsed.state} execution requirements: witnesses, notarization, etc.>\",\n      \"estimatedCostToCreate\": {\"low\": <number>, \"high\": <number>},\n      \"scenarioImpact\": \"<what happens in death/incapacity scenario without this document>\",\n      \"questionsForAttorney\": [\"<specific question 1>\", \"<specific question 2>\"]\n    }\n  ],\n\n  \"outdatedDocuments\": [\n    {\n      \"document\": \"<document name>\",\n      \"issue\": \"<what's outdated or problematic>\",\n      \"risk\": \"<specific risk this creates>\",\n      \"recommendation\": \"<what to do>\",\n      \"estimatedUpdateCost\": {\"low\": <number>, \"high\": <number>}\n    }\n  ],\n\n  \"inconsistencies\": [\n    {\n      \"type\": \"<beneficiary mismatch/document conflict/goal misalignment>\",\n      \"severity\": \"<critical/high/medium/low>\",\n      \"issue\": \"<clear description of the inconsistency>\",\n      \"document1\": \"<first document or source>\",\n      \"document2\": \"<second document or source>\",\n      \"potentialConsequence\": \"<what could go wrong>\",\n      \"resolution\": \"<how to fix it>\",\n      \"estimatedResolutionCost\": {\"low\": <number>, \"high\": <number>}\n    }\n  ],\n\n  \"financialExposure\": {\n    \"estimatedProbateCost\": {\n      \"low\": <number>,\n      \"high\": <number>,\n      \"methodology\": \"<${parsed.state} statutory fee calculation with actual math>\",\n      \"statutoryBasis\": \"<cite specific ${parsed.state} probate code section>\"\n    },\n    \"estimatedEstateTax\": {\n      \"federal\": <number based on current exemption>,\n      \"state\": <number based on ${parsed.state} estate/inheritance tax>,\n      \"notes\": \"<explain calculation, mention 2026 sunset if relevant>\"\n    },\n    \"probateTimeEstimate\": \"<X-Y months typical for ${parsed.state}>\",\n    \"assetsSubjectToProbate\": <estimated dollar amount>\n  },\n\n  \"taxStrategies\": [\n    {\n      \"strategy\": \"<strategy name>\",\n      \"applicability\": \"<why specifically relevant for THIS client>\",\n      \"estimatedSavings\": {\"low\": <number>, \"high\": <number>},\n      \"complexity\": \"<low/medium/high>\",\n      \"implementationSteps\": [\"<step 1>\", \"<step 2>\", \"<step 3>\"],\n      \"professionalNeeded\": \"<type of professional required>\",\n      \"timeToImplement\": \"<estimated timeline>\"\n    }\n  ],\n\n  \"stateSpecificNotes\": [\n    {\n      \"topic\": \"<legal topic>\",\n      \"rule\": \"<${parsed.state} specific rule - be precise>\",\n      \"impact\": \"<how it specifically affects THIS client>\",\n      \"action\": \"<what the client should do>\",\n      \"citation\": \"<${parsed.state} statute or code section>\"\n    }\n  ],\n\n  \"recommendations\": [\n    {\n      \"rank\": <1-10>,\n      \"action\": \"<specific, actionable recommendation>\",\n      \"category\": \"<documents/tax/beneficiaries/titling/insurance/other>\",\n      \"priority\": \"<critical/high/medium/low>\",\n      \"timeline\": \"<immediate/30-days/90-days/12-months>\",\n      \"estimatedCost\": {\"low\": <number>, \"high\": <number>},\n      \"estimatedBenefit\": \"<quantified benefit where possible>\",\n      \"detailedSteps\": [\n        \"<Step 1: specific action>\",\n        \"<Step 2: specific action>\",\n        \"<Step 3: specific action>\"\n      ],\n      \"professionalNeeded\": \"<estate attorney/CPA/financial advisor/none>\",\n      \"riskOfDelay\": \"<what happens if this waits>\",\n      \"questionsForAttorney\": [\"<question 1>\", \"<question 2>\"]\n    }\n  ],\n\n  \"scenarioAnalysis\": [\n    {\n      \"scenario\": \"<death of primary earner/both spouses/incapacity/etc.>\",\n      \"currentOutcome\": \"<what happens with current documents>\",\n      \"desiredOutcome\": \"<what client presumably wants>\",\n      \"gaps\": [\"<gap 1>\", \"<gap 2>\"],\n      \"financialImpact\": \"<dollar estimate of gap>\",\n      \"recommendedFixes\": [\"<fix 1>\", \"<fix 2>\"]\n    }\n  ],\n\n  \"uncertaintyLog\": {\n    \"informationGaps\": [\n      {\n        \"gap\": \"<what information is missing>\",\n        \"impactOnAnalysis\": \"<how it limits conclusions>\",\n        \"howToResolve\": \"<what client should provide>\"\n      }\n    ],\n    \"assumptionsMade\": [\n      {\n        \"assumption\": \"<what was assumed>\",\n        \"ifWrong\": \"<how conclusions would change>\"\n      }\n    ],\n    \"confidenceLevels\": {\n      \"overallAnalysis\": \"<high/medium/low>\",\n      \"scoreAccuracy\": \"<high/medium/low>\",\n      \"costEstimates\": \"<high/medium/low>\"\n    }\n  },\n\n  \"targetStateSummary\": {\n    \"ifAllRecommendationsImplemented\": {\n      \"newScore\": <projected score>,\n      \"protections\": [\"<what would be protected>\"],\n      \"optimizations\": [\"<tax savings, efficiency gains>\"],\n      \"alignments\": [\"<how plan matches goals>\"],\n      \"survivedScenarios\": [\"<what scenarios plan now handles>\"]\n    },\n    \"comparisonTable\": [\n      {\n        \"metric\": \"<metric name>\",\n        \"current\": \"<current state>\",\n        \"target\": \"<target state>\",\n        \"improvement\": \"<quantified improvement>\"\n      }\n    ]\n  },\n\n  \"executiveSummary\": {\n    \"oneLineSummary\": \"<One sentence capturing the most important insight>\",\n    \"criticalIssues\": [\"<issue 1 - most urgent>\", \"<issue 2>\", \"<issue 3>\"],\n    \"immediateActions\": [\"<action 1 - do this week>\", \"<action 2>\"],\n    \"biggestRisks\": [\"<risk 1>\", \"<risk 2>\", \"<risk 3>\"],\n    \"biggestOpportunities\": [\"<opportunity 1>\", \"<opportunity 2>\"]\n  }\n}\n\n---\n\n## SCORING GUIDE\nStart at 100, deduct based on severity:\n- No Will: -15 (critical)\n- No Trust (estate >$500K): -10 (high)\n- No Financial POA: -10 (critical)\n- No Healthcare POA: -8 (critical)\n- No Healthcare Directive: -5 (high)\n- Minor children, no guardian: -10 (critical)\n- Beneficiary misalignment: -5 to -10 depending on severity\n- State probate exposure (high-cost state, no trust): -5\n- Outdated documents (>5 years): -3 to -5\n\n## QUALITY REQUIREMENTS\n1. Every finding must cite specific client data that supports it\n2. Every dollar estimate must show methodology\n3. Every ${parsed.state} reference must include statute citation where applicable\n4. Every recommendation must include specific next steps\n5. No generic advice - everything must be personalized to THIS client\n6. Acknowledge uncertainty where it exists\n7. The output should feel like a senior attorney spent an hour reviewing the case\n\nWrite the complete JSON file now. Be thorough and specific.`;\n}\n\n// Attempt to repair truncated JSON by closing open brackets\nfunction repairJSON(json: string): string {\n  let repaired = json.trim();\n\n  // First, try to find where the JSON becomes invalid by parsing progressively\n  // Find a valid truncation point\n  let validEnd = repaired.length;\n\n  // Try to parse, and if it fails, try truncating at different points\n  for (let attempts = 0; attempts < 50; attempts++) {\n    try {\n      // Try to find a good truncation point - look for complete objects/arrays\n      let testJson = repaired.substring(0, validEnd);\n\n      // Remove trailing incomplete content\n      testJson = testJson.replace(/,\\s*\"[^\"]*\":\\s*\"[^\"]*$/, '');  // incomplete string value\n      testJson = testJson.replace(/,\\s*\"[^\"]*\":\\s*\\[[^\\]]*$/, ''); // incomplete array\n      testJson = testJson.replace(/,\\s*\"[^\"]*\":\\s*\\{[^}]*$/, '');  // incomplete object\n      testJson = testJson.replace(/,\\s*\"[^\"]*\":\\s*\"?[^\",}\\]]*$/, '');\n      testJson = testJson.replace(/,\\s*\"[^\"]*\":\\s*$/, '');\n      testJson = testJson.replace(/,\\s*\"[^\"]*$/, '');\n      testJson = testJson.replace(/,\\s*$/, '');\n\n      // Count and close brackets\n      let openBraces = 0;\n      let openBrackets = 0;\n      let inString = false;\n      let escapeNext = false;\n\n      for (const char of testJson) {\n        if (escapeNext) {\n          escapeNext = false;\n          continue;\n        }\n        if (char === '\\\\') {\n          escapeNext = true;\n          continue;\n        }\n        if (char === '\"') {\n          inString = !inString;\n          continue;\n        }\n        if (!inString) {\n          if (char === '{') openBraces++;\n          if (char === '}') openBraces--;\n          if (char === '[') openBrackets++;\n          if (char === ']') openBrackets--;\n        }\n      }\n\n      // If we're in a string, close it\n      if (inString) {\n        testJson += '\"';\n      }\n\n      // Close any open brackets/braces\n      while (openBrackets > 0) {\n        testJson += ']';\n        openBrackets--;\n      }\n      while (openBraces > 0) {\n        testJson += '}';\n        openBraces--;\n      }\n\n      // Try parsing\n      JSON.parse(testJson);\n      return testJson;\n    } catch (e) {\n      // Get error position if available\n      const errorMsg = (e as Error).message;\n      const posMatch = errorMsg.match(/position (\\d+)/);\n      if (posMatch) {\n        const errorPos = parseInt(posMatch[1], 10);\n        // Truncate before the error and try again\n        validEnd = Math.min(validEnd - 100, errorPos - 10);\n      } else {\n        validEnd -= 500;\n      }\n\n      if (validEnd < 1000) {\n        // Give up - too much truncation\n        break;\n      }\n    }\n  }\n\n  // Fallback: aggressive truncation to find last complete property\n  // Find the last complete \"key\": value pattern\n  const lastCompleteProperty = repaired.lastIndexOf('\",');\n  if (lastCompleteProperty > 1000) {\n    let truncated = repaired.substring(0, lastCompleteProperty + 1);\n\n    // Close brackets\n    let openBraces = (truncated.match(/\\{/g) || []).length - (truncated.match(/\\}/g) || []).length;\n    let openBrackets = (truncated.match(/\\[/g) || []).length - (truncated.match(/\\]/g) || []).length;\n\n    while (openBrackets > 0) {\n      truncated += ']';\n      openBrackets--;\n    }\n    while (openBraces > 0) {\n      truncated += '}';\n      openBraces--;\n    }\n\n    try {\n      JSON.parse(truncated);\n      return truncated;\n    } catch {\n      // Continue to original method\n    }\n  }\n\n  // Original repair logic as final fallback\n  repaired = repaired.replace(/,\\s*\"[^\"]*\":\\s*\"?[^\",}\\]]*$/, '');\n  repaired = repaired.replace(/,\\s*\"[^\"]*\":\\s*$/, '');\n  repaired = repaired.replace(/,\\s*\"[^\"]*$/, '');\n  repaired = repaired.replace(/,\\s*$/, '');\n\n  let openBraces = 0;\n  let openBrackets = 0;\n  let inString = false;\n  let escapeNext = false;\n\n  for (const char of repaired) {\n    if (escapeNext) {\n      escapeNext = false;\n      continue;\n    }\n    if (char === '\\\\') {\n      escapeNext = true;\n      continue;\n    }\n    if (char === '\"') {\n      inString = !inString;\n      continue;\n    }\n    if (!inString) {\n      if (char === '{') openBraces++;\n      if (char === '}') openBraces--;\n      if (char === '[') openBrackets++;\n      if (char === ']') openBrackets--;\n    }\n  }\n\n  if (inString) {\n    repaired += '\"';\n  }\n\n  while (openBrackets > 0) {\n    repaired += ']';\n    openBrackets--;\n  }\n  while (openBraces > 0) {\n    repaired += '}';\n    openBraces--;\n  }\n\n  return repaired;\n}\n\nfunction extractJSON(result: { stdout?: string; fileContent?: string }): Record<string, unknown> | null {\n  console.log(\"extractJSON called, fileContent length:\", result.fileContent?.length || 0, \"stdout length:\", result.stdout?.length || 0);\n\n  // Try file content first (most reliable)\n  if (result.fileContent && result.fileContent.trim()) {\n    try {\n      const parsed = JSON.parse(result.fileContent);\n      console.log(\"Successfully parsed fileContent, keys:\", Object.keys(parsed));\n      return parsed;\n    } catch (e) {\n      console.error(\"Failed to parse fileContent:\", e);\n      console.error(\"fileContent preview:\", result.fileContent.substring(0, 500));\n\n      // Try to repair truncated JSON\n      try {\n        console.log(\"Attempting to repair JSON, original length:\", result.fileContent.length);\n        const repaired = repairJSON(result.fileContent);\n        console.log(\"Repaired JSON length:\", repaired.length);\n        const parsed = JSON.parse(repaired);\n        console.log(\"Successfully parsed REPAIRED fileContent, keys:\", Object.keys(parsed));\n        return parsed;\n      } catch (repairError) {\n        console.error(\"Failed to repair JSON:\", repairError);\n        // Log the area around the error\n        const errorMsg = (repairError as Error).message;\n        const posMatch = errorMsg.match(/position (\\d+)/);\n        if (posMatch) {\n          const pos = parseInt(posMatch[1], 10);\n          console.error(\"Error context around position\", pos, \":\", result.fileContent.substring(Math.max(0, pos - 100), pos + 100));\n        }\n      }\n    }\n  }\n\n  // Try to extract from stdout\n  if (result.stdout) {\n    console.log(\"Attempting to extract JSON from stdout, length:\", result.stdout.length);\n    console.log(\"stdout preview (first 500 chars):\", result.stdout.substring(0, 500));\n    console.log(\"stdout preview (last 500 chars):\", result.stdout.slice(-500));\n\n    // Try code block first\n    const codeBlockMatch = result.stdout.match(/```(?:json)?\\s*\\n([\\s\\S]*?)\\n```/);\n    if (codeBlockMatch) {\n      try {\n        const parsed = JSON.parse(codeBlockMatch[1]);\n        console.log(\"Successfully parsed code block JSON, keys:\", Object.keys(parsed));\n        return parsed;\n      } catch (e) {\n        console.error(\"Failed to parse code block JSON:\", e);\n      }\n    }\n\n    // Try to find raw JSON object starting with {\"score\"\n    const analysisMatch = result.stdout.match(/\\{\"score\"[\\s\\S]*\\}(?=\\s*$|\\s*\\n\\s*===)/);\n    if (analysisMatch) {\n      try {\n        const parsed = JSON.parse(analysisMatch[0]);\n        console.log(\"Successfully parsed analysis JSON from stdout, keys:\", Object.keys(parsed));\n        return parsed;\n      } catch (e) {\n        console.error(\"Failed to parse analysis JSON:\", e);\n      }\n    }\n\n    // Fallback: Try to find JSON starting with {\"score\"\n    const jsonStart = result.stdout.indexOf('{\"score\"');\n    if (jsonStart !== -1) {\n      let braceCount = 0;\n      let jsonEnd = -1;\n      for (let i = jsonStart; i < result.stdout.length; i++) {\n        if (result.stdout[i] === '{') braceCount++;\n        if (result.stdout[i] === '}') {\n          braceCount--;\n          if (braceCount === 0) {\n            jsonEnd = i;\n            break;\n          }\n        }\n      }\n      if (jsonEnd !== -1) {\n        try {\n          const parsed = JSON.parse(result.stdout.substring(jsonStart, jsonEnd + 1));\n          console.log(\"Successfully parsed JSON with brace matching, keys:\", Object.keys(parsed));\n          return parsed;\n        } catch (e) {\n          console.error(\"Failed to parse JSON with brace matching:\", e);\n          // Try to repair truncated JSON\n          try {\n            const repaired = repairJSON(result.stdout.substring(jsonStart, jsonEnd + 1));\n            const parsed = JSON.parse(repaired);\n            console.log(\"Successfully parsed REPAIRED stdout JSON, keys:\", Object.keys(parsed));\n            return parsed;\n          } catch (repairError) {\n            console.error(\"Failed to repair stdout JSON:\", repairError);\n          }\n        }\n      }\n    }\n\n    // Try to find any JSON object containing analysis keys\n    const anyJsonMatch = result.stdout.match(/\\{[^{}]*\"missingDocuments\"[^{}]*[\\s\\S]*\\}/);\n    if (anyJsonMatch) {\n      try {\n        const parsed = JSON.parse(anyJsonMatch[0]);\n        console.log(\"Successfully parsed JSON with missingDocuments key, keys:\", Object.keys(parsed));\n        return parsed;\n      } catch (e) {\n        // Try brace matching\n        const start = result.stdout.indexOf(anyJsonMatch[0]);\n        let braceCount = 0;\n        let end = -1;\n        for (let i = start; i < result.stdout.length; i++) {\n          if (result.stdout[i] === '{') braceCount++;\n          if (result.stdout[i] === '}') {\n            braceCount--;\n            if (braceCount === 0) {\n              end = i;\n              break;\n            }\n          }\n        }\n        if (end !== -1) {\n          try {\n            const repaired = repairJSON(result.stdout.substring(start, end + 1));\n            const parsed = JSON.parse(repaired);\n            console.log(\"Successfully parsed repaired analysis JSON, keys:\", Object.keys(parsed));\n            return parsed;\n          } catch {\n            console.error(\"Failed to repair analysis JSON\");\n          }\n        }\n      }\n    }\n  }\n\n  console.error(\"extractJSON: No valid JSON found\");\n  console.error(\"Full stdout for debugging:\", result.stdout?.slice(0, 2000));\n  return null;\n}\n\n// Calculate score based on document completeness and risk factors\nfunction calculateScore(parsed: ParsedIntake, analysisResult: Record<string, unknown>): number {\n  let score = 100;\n  const ctx = getClientContext(parsed);\n\n  // Core documents (40 points total)\n  if (!ctx.hasWill) score -= 15;\n  if (!ctx.hasPOAFinancial) score -= 10;\n  if (!ctx.hasPOAHealthcare) score -= 8;\n  if (!ctx.hasHealthcareDirective) score -= 7;\n\n  // Trust consideration (15 points)\n  if (!ctx.hasTrust) {\n    if (ctx.estimatedValue > 1000000) score -= 15;\n    else if (ctx.estimatedValue > 500000) score -= 10;\n    else if (ctx.estimatedValue > 100000) score -= 5;\n  }\n\n  // Minor children (15 points)\n  if (ctx.hasMinorChildren) {\n    const familyData = parsed.family as Record<string, unknown>;\n    if (!familyData?.guardian) score -= 10;\n    if (!ctx.hasWill) score -= 5;\n  }\n\n  // Beneficiary tracking (10 points)\n  if (parsed.beneficiaries.length === 0 && ctx.estimatedValue > 50000) {\n    score -= 10;\n  }\n\n  // Marital considerations (10 points)\n  if (ctx.isMarried) {\n    if (!ctx.hasWill && !ctx.hasTrust) score -= 5;\n    if (ctx.estimatedValue > 500000 && !ctx.hasTrust) score -= 5;\n  }\n\n  // High probate states (5 points)\n  const highProbateStates = [\"CA\", \"California\", \"NY\", \"New York\", \"FL\", \"Florida\"];\n  if (highProbateStates.includes(parsed.state) && !ctx.hasTrust && ctx.estimatedValue > 100000) {\n    score -= 5;\n  }\n\n  // Outdated documents penalty\n  const outdatedDocs = analysisResult?.outdatedDocuments as Array<unknown> || [];\n  if (outdatedDocs.length > 0) {\n    score -= Math.min(5, outdatedDocs.length * 2);\n  }\n\n  return Math.max(0, Math.min(100, Math.round(score)));\n}\n\nexport async function POST(req: Request) {\n  try {\n    const body = await req.json();\n    const { intakeData, mode = \"quick\", estatePlanId } = body;\n\n    if (!intakeData) {\n      return NextResponse.json({ error: \"Intake data is required\" }, { status: 400 });\n    }\n\n    // If comprehensive mode, redirect to orchestration endpoint\n    if (mode === \"comprehensive\") {\n      if (!estatePlanId) {\n        return NextResponse.json(\n          { error: \"estatePlanId is required for comprehensive analysis\" },\n          { status: 400 }\n        );\n      }\n\n      // Forward to orchestration endpoint\n      const orchestrateUrl = new URL(\"/api/gap-analysis/orchestrate\", req.url);\n      const orchestrateResponse = await fetch(orchestrateUrl.toString(), {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ estatePlanId, intakeData }),\n      });\n\n      const orchestrateResult = await orchestrateResponse.json();\n      return NextResponse.json({\n        ...orchestrateResult,\n        mode: \"comprehensive\",\n      });\n    }\n\n    // Quick mode - single run with simplified prompt for faster results\n    // Parse the intake data\n    const parsed = parseIntakeData(intakeData);\n    const ctx = getClientContext(parsed);\n\n    console.log(\"Starting QUICK gap analysis...\");\n    console.log(\"Client context:\", JSON.stringify(ctx));\n\n    // Build simplified quick analysis prompt (faster, essential findings only)\n    const prompt = buildQuickAnalysisPrompt(parsed);\n    const result = await executeInE2B({\n      prompt,\n      outputFile: \"analysis.json\",\n      timeoutMs: 300000, // 5 minute timeout for quick analysis\n      maxTurns: 5,\n      runType: \"quick_analysis\",\n    });\n\n    console.log(\"E2B result:\", {\n      success: result.success,\n      hasFileContent: !!result.fileContent,\n      fileContentLength: result.fileContent?.length,\n      error: result.error,\n    });\n\n    if (!result.success) {\n      throw new Error(result.error || \"E2B execution failed\");\n    }\n\n    // Extract JSON from result\n    let analysisResult = extractJSON(result);\n\n    // Calculate and validate score\n    const calculatedScore = calculateScore(parsed, analysisResult || {});\n\n    if (analysisResult) {\n      // Blend AI score with calculated score\n      if (analysisResult.overallScore && typeof analysisResult.overallScore === 'object') {\n        const overallScore = analysisResult.overallScore as Record<string, unknown>;\n        const aiScore = typeof overallScore.score === 'number' ? overallScore.score : calculatedScore;\n        overallScore.score = Math.round((aiScore * 0.7) + (calculatedScore * 0.3));\n        overallScore.calculatedScore = calculatedScore;\n        overallScore.aiGeneratedScore = aiScore;\n      } else {\n        analysisResult.overallScore = {\n          score: calculatedScore,\n          grade: calculatedScore >= 90 ? 'A' : calculatedScore >= 80 ? 'B' : calculatedScore >= 70 ? 'C' : calculatedScore >= 60 ? 'D' : 'F',\n          summary: \"Score calculated based on document completeness and estate planning best practices.\"\n        };\n      }\n      analysisResult.score = (analysisResult.overallScore as Record<string, unknown>).score;\n    } else {\n      // Fallback if parsing failed\n      analysisResult = {\n        score: calculatedScore,\n        overallScore: {\n          score: calculatedScore,\n          grade: calculatedScore >= 90 ? 'A' : calculatedScore >= 80 ? 'B' : calculatedScore >= 70 ? 'C' : calculatedScore >= 60 ? 'D' : 'F',\n          summary: \"Analysis completed. Please review the details below.\"\n        },\n        missingDocuments: [],\n        outdatedDocuments: [],\n        inconsistencies: [],\n        taxStrategies: [],\n        stateSpecificNotes: [],\n        recommendations: [],\n        scenarioAnalysis: [],\n        preAnalysisInsights: {},\n        uncertaintyLog: {},\n        targetStateSummary: {},\n        executiveSummary: { criticalIssues: [], immediateActions: [], biggestRisks: [] },\n      };\n    }\n\n    // Ensure all arrays exist\n    analysisResult.missingDocuments = analysisResult.missingDocuments || [];\n    analysisResult.outdatedDocuments = analysisResult.outdatedDocuments || [];\n    analysisResult.inconsistencies = analysisResult.inconsistencies || [];\n    analysisResult.taxStrategies = analysisResult.taxStrategies || [];\n    analysisResult.stateSpecificNotes = analysisResult.stateSpecificNotes || analysisResult.stateSpecificConsiderations || [];\n    analysisResult.recommendations = analysisResult.recommendations || analysisResult.prioritizedRecommendations || [];\n    analysisResult.scenarioAnalysis = analysisResult.scenarioAnalysis || [];\n\n    console.log(\"Final deep analysis:\", {\n      score: analysisResult.score,\n      missingDocsCount: (analysisResult.missingDocuments as unknown[]).length,\n      recommendationsCount: (analysisResult.recommendations as unknown[]).length,\n      stateNotesCount: (analysisResult.stateSpecificNotes as unknown[]).length,\n      hasPreAnalysisInsights: !!analysisResult.preAnalysisInsights,\n      hasScenarioAnalysis: (analysisResult.scenarioAnalysis as unknown[]).length > 0,\n      hasUncertaintyLog: !!analysisResult.uncertaintyLog,\n    });\n\n    return NextResponse.json({\n      success: true,\n      analysisResult,\n      stdout: result.stdout,\n    });\n\n  } catch (error) {\n    console.error(\"Gap analysis error:\", error);\n    return NextResponse.json(\n      {\n        success: false,\n        error: error instanceof Error ? error.message : \"Unknown error\"\n      },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":"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"}}]
}