{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 76, "column": 0}, "map": {"version":3,"sources":["file:///Users/prestondinh/SICC/mvp/lib/e2b-executor.ts"],"sourcesContent":["import { Sandbox } from \"e2b\";\n\n// Skills content\nconst SKILLS = {\n  \"estate-document-analyzer\": {\n    \"SKILL.md\": `# Estate Document Analyzer Skill\n\nYou are an expert estate planning document analyzer. When given estate planning documents (wills, trusts, POAs, etc.), you:\n\n1. **Extract Key Information**:\n   - Document type and date\n   - Principal/grantor name\n   - Named parties (executors, trustees, agents, beneficiaries)\n   - Key provisions and terms\n\n2. **Identify Issues**:\n   - Missing signatures or witnesses\n   - Outdated information\n   - Ambiguous language\n   - Potential conflicts with other documents\n\n3. **Provide Recommendations**:\n   - Suggest updates needed\n   - Flag inconsistencies\n   - Note state-specific compliance issues\n\nOutput format: JSON with sections for extracted_info, issues, and recommendations.`\n  },\n  \"estate-goals-profiler\": {\n    \"SKILL.md\": `# Estate Goals Profiler Skill\n\nYou help clients articulate and prioritize their estate planning goals. You:\n\n1. **Identify Goals**:\n   - Asset protection\n   - Tax minimization\n   - Family provision\n   - Charitable giving\n   - Business succession\n   - Healthcare directives\n\n2. **Assess Priorities**:\n   - Rank goals by importance\n   - Identify potential conflicts\n   - Suggest compromise solutions\n\n3. **Recommend Documents**:\n   - Map goals to specific documents needed\n   - Prioritize document creation order\n\nOutput format: JSON with prioritized_goals, conflicts, and document_recommendations.`\n  },\n  \"financial-profile-classifier\": {\n    \"SKILL.md\": `# Financial Profile Classifier Skill\n\nYou analyze financial situations for estate planning purposes. You:\n\n1. **Classify Estate Size**:\n   - Simple (under $1M)\n   - Moderate ($1M - $5M)\n   - Complex ($5M - $12M)\n   - High Net Worth ($12M+)\n\n2. **Identify Tax Implications**:\n   - Federal estate tax exposure\n   - State estate/inheritance tax\n   - Gift tax considerations\n   - Generation-skipping tax\n\n3. **Recommend Strategies**:\n   - Basic will vs. living trust\n   - Irrevocable trust options\n   - Charitable planning\n   - Life insurance planning\n\nOutput format: JSON with classification, tax_exposure, and strategy_recommendations.`\n  },\n  \"us-estate-planning-analyzer\": {\n    \"SKILL.md\": `# US Estate Planning Analyzer Skill\n\nYou are an expert in US estate planning law. You analyze estate plans for:\n\n1. **Federal Compliance**:\n   - Estate tax exemption limits (current: $13.61M per person)\n   - Gift tax annual exclusion ($18,000 per recipient)\n   - Portability elections\n   - QTIP trust requirements\n\n2. **State-Specific Rules**:\n   - Community property vs. common law states\n   - State estate tax thresholds\n   - State inheritance taxes\n   - Homestead exemptions\n\n3. **Document Requirements**:\n   - Will execution requirements by state\n   - Trust formation rules\n   - POA statutory forms\n   - Healthcare directive compliance\n\n4. **Gap Analysis**:\n   - Missing essential documents\n   - Outdated provisions\n   - Beneficiary inconsistencies\n   - Tax optimization opportunities\n\nOutput format: JSON with compliance_status, state_specific_issues, gaps, and recommendations.`\n  }\n};\n\nconst OUTPUT_DIR = \"/home/user/generated\";\nconst SKILLS_DIR = \"/home/user/.claude/skills\";\n\nexport interface E2BExecuteResult {\n  success: boolean;\n  stdout?: string;\n  stderr?: string;\n  exitCode?: number;\n  fileContent?: string;\n  error?: string;\n  // Metadata from --output-format json\n  metadata?: {\n    numTurns?: number;\n    durationMs?: number;\n    totalCostUsd?: number;\n    sessionId?: string;\n    usage?: {\n      inputTokens?: number;\n      outputTokens?: number;\n      cacheReadInputTokens?: number;\n      cacheCreationInputTokens?: number;\n    };\n  };\n}\n\nexport interface E2BExecuteOptions {\n  prompt: string;\n  outputFile?: string;\n  timeoutMs?: number;\n}\n\n/**\n * Execute Claude Code in E2B sandbox\n * This is a shared function that can be called directly without HTTP\n */\nexport async function executeInE2B(options: E2BExecuteOptions): Promise<E2BExecuteResult> {\n  const { prompt, outputFile, timeoutMs = 240000 } = options;\n\n  const E2B_API_KEY = process.env.E2B_API_KEY;\n  const ANTHROPIC_API_KEY = process.env.ANTHROPIC_API_KEY;\n\n  if (!E2B_API_KEY || !ANTHROPIC_API_KEY) {\n    return { success: false, error: \"API keys not configured\" };\n  }\n\n  // Create sandbox with very long timeout for comprehensive analysis\n  const sandbox = await Sandbox.create(\"base\", {\n    timeoutMs: 1800000, // 30 minutes sandbox lifetime\n    apiKey: E2B_API_KEY,\n  });\n\n  try {\n    // Create directories\n    await sandbox.commands.run(`mkdir -p ${OUTPUT_DIR}`);\n    await sandbox.commands.run(`mkdir -p ${SKILLS_DIR}`);\n\n    // Inject skills\n    for (const [skillName, files] of Object.entries(SKILLS)) {\n      const skillDir = `${SKILLS_DIR}/${skillName}`;\n      await sandbox.commands.run(`mkdir -p \"${skillDir}\"`);\n      for (const [fileName, content] of Object.entries(files)) {\n        await sandbox.files.write(`${skillDir}/${fileName}`, content);\n      }\n    }\n\n    // Create wrapper script\n    const wrapperScript = `\n#!/bin/bash\nset -e\n\ncd ${OUTPUT_DIR}\n\n# Install Claude Code CLI\nnpm install -g @anthropic-ai/claude-code 2>&1 || {\n    echo \"Failed to install claude-code, trying npx...\"\n    export USE_NPX=1\n}\n\n# Create prompt file\ncat > /tmp/prompt.txt << 'PROMPT_EOF'\n${prompt.replace(/'/g, \"'\\\\''\")}\nPROMPT_EOF\n\necho \"=== Starting Claude Code ===\"\necho \"Working directory: $(pwd)\"\necho \"Available skills:\"\nls -la $HOME/.claude/skills/ 2>/dev/null || echo \"(no skills)\"\n\n# Run Claude Code with safety limits and structured output\nif [ \"\\${USE_NPX:-}\" = \"1\" ]; then\n    npx -y @anthropic-ai/claude-code --print --dangerously-skip-permissions --output-format json --max-turns 5 -p \"$(cat /tmp/prompt.txt)\" 2>&1\nelse\n    claude --print --dangerously-skip-permissions --output-format json --max-turns 5 -p \"$(cat /tmp/prompt.txt)\" 2>&1\nfi\n\necho \"\"\necho \"=== Claude Code Finished ===\"\necho \"Generated files:\"\nls -la ${OUTPUT_DIR}/ 2>/dev/null || echo \"(none)\"\n`;\n\n    await sandbox.files.write(\"/tmp/run_claude.sh\", wrapperScript);\n    await sandbox.commands.run(\"chmod +x /tmp/run_claude.sh\");\n\n    // Run Claude Code with very long timeout\n    const result = await sandbox.commands.run(\"bash /tmp/run_claude.sh\", {\n      envs: {\n        ANTHROPIC_API_KEY,\n        HOME: \"/home/user\",\n        CI: \"true\",\n      },\n      timeoutMs: 900000, // 15 minutes per command\n    });\n\n    // Try to read output file if specified\n    let fileContent = \"\";\n    if (outputFile) {\n      try {\n        fileContent = await sandbox.files.read(`${OUTPUT_DIR}/${outputFile}`);\n      } catch {\n        // Try to find any file with similar name\n        const listResult = await sandbox.commands.run(\n          `find ${OUTPUT_DIR} -type f 2>/dev/null || true`\n        );\n        const files = listResult.stdout.split(\"\\n\").filter((f: string) => f.trim());\n        if (files.length > 0) {\n          fileContent = await sandbox.files.read(files[0]);\n        }\n      }\n    }\n\n    // Extract metadata from JSON output (--output-format json)\n    let metadata: E2BExecuteResult[\"metadata\"];\n    try {\n      const jsonMatch = result.stdout.match(/\\{[\\s\\S]*\"num_turns\"[\\s\\S]*\\}/);\n      if (jsonMatch) {\n        const parsed = JSON.parse(jsonMatch[0]);\n        metadata = {\n          numTurns: parsed.num_turns,\n          durationMs: parsed.duration_ms,\n          totalCostUsd: parsed.total_cost_usd,\n          sessionId: parsed.session_id,\n          usage: parsed.usage ? {\n            inputTokens: parsed.usage.input_tokens,\n            outputTokens: parsed.usage.output_tokens,\n            cacheReadInputTokens: parsed.usage.cache_read_input_tokens,\n            cacheCreationInputTokens: parsed.usage.cache_creation_input_tokens,\n          } : undefined,\n        };\n      }\n    } catch {\n      // Metadata extraction is best-effort, don't fail if it doesn't work\n    }\n\n    return {\n      success: true,\n      stdout: result.stdout,\n      stderr: result.stderr,\n      exitCode: result.exitCode,\n      fileContent,\n      metadata,\n    };\n  } finally {\n    await sandbox.kill();\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;;AAEA,iBAAiB;AACjB,MAAM,SAAS;IACb,4BAA4B;QAC1B,YAAY,CAAC;;;;;;;;;;;;;;;;;;;;;kFAqBiE,CAAC;IACjF;IACA,yBAAyB;QACvB,YAAY,CAAC;;;;;;;;;;;;;;;;;;;;;oFAqBmE,CAAC;IACnF;IACA,gCAAgC;QAC9B,YAAY,CAAC;;;;;;;;;;;;;;;;;;;;;;oFAsBmE,CAAC;IACnF;IACA,+BAA+B;QAC7B,YAAY,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;6FA4B4E,CAAC;IAC5F;AACF;AAEA,MAAM,aAAa;AACnB,MAAM,aAAa;AAkCZ,eAAe,aAAa,OAA0B;IAC3D,MAAM,EAAE,MAAM,EAAE,UAAU,EAAE,YAAY,MAAM,EAAE,GAAG;IAEnD,MAAM,cAAc,QAAQ,GAAG,CAAC,WAAW;IAC3C,MAAM,oBAAoB,QAAQ,GAAG,CAAC,iBAAiB;IAEvD,IAAI,CAAC,eAAe,CAAC,mBAAmB;QACtC,OAAO;YAAE,SAAS;YAAO,OAAO;QAA0B;IAC5D;IAEA,mEAAmE;IACnE,MAAM,UAAU,MAAM,kJAAO,CAAC,MAAM,CAAC,QAAQ;QAC3C,WAAW;QACX,QAAQ;IACV;IAEA,IAAI;QACF,qBAAqB;QACrB,MAAM,QAAQ,QAAQ,CAAC,GAAG,CAAC,CAAC,SAAS,EAAE,YAAY;QACnD,MAAM,QAAQ,QAAQ,CAAC,GAAG,CAAC,CAAC,SAAS,EAAE,YAAY;QAEnD,gBAAgB;QAChB,KAAK,MAAM,CAAC,WAAW,MAAM,IAAI,OAAO,OAAO,CAAC,QAAS;YACvD,MAAM,WAAW,GAAG,WAAW,CAAC,EAAE,WAAW;YAC7C,MAAM,QAAQ,QAAQ,CAAC,GAAG,CAAC,CAAC,UAAU,EAAE,SAAS,CAAC,CAAC;YACnD,KAAK,MAAM,CAAC,UAAU,QAAQ,IAAI,OAAO,OAAO,CAAC,OAAQ;gBACvD,MAAM,QAAQ,KAAK,CAAC,KAAK,CAAC,GAAG,SAAS,CAAC,EAAE,UAAU,EAAE;YACvD;QACF;QAEA,wBAAwB;QACxB,MAAM,gBAAgB,CAAC;;;;GAIxB,EAAE,WAAW;;;;;;;;;;AAUhB,EAAE,OAAO,OAAO,CAAC,MAAM,SAAS;;;;;;;;;;;;;;;;;;OAkBzB,EAAE,WAAW;AACpB,CAAC;QAEG,MAAM,QAAQ,KAAK,CAAC,KAAK,CAAC,sBAAsB;QAChD,MAAM,QAAQ,QAAQ,CAAC,GAAG,CAAC;QAE3B,yCAAyC;QACzC,MAAM,SAAS,MAAM,QAAQ,QAAQ,CAAC,GAAG,CAAC,2BAA2B;YACnE,MAAM;gBACJ;gBACA,MAAM;gBACN,IAAI;YACN;YACA,WAAW;QACb;QAEA,uCAAuC;QACvC,IAAI,cAAc;QAClB,IAAI,YAAY;YACd,IAAI;gBACF,cAAc,MAAM,QAAQ,KAAK,CAAC,IAAI,CAAC,GAAG,WAAW,CAAC,EAAE,YAAY;YACtE,EAAE,OAAM;gBACN,yCAAyC;gBACzC,MAAM,aAAa,MAAM,QAAQ,QAAQ,CAAC,GAAG,CAC3C,CAAC,KAAK,EAAE,WAAW,4BAA4B,CAAC;gBAElD,MAAM,QAAQ,WAAW,MAAM,CAAC,KAAK,CAAC,MAAM,MAAM,CAAC,CAAC,IAAc,EAAE,IAAI;gBACxE,IAAI,MAAM,MAAM,GAAG,GAAG;oBACpB,cAAc,MAAM,QAAQ,KAAK,CAAC,IAAI,CAAC,KAAK,CAAC,EAAE;gBACjD;YACF;QACF;QAEA,2DAA2D;QAC3D,IAAI;QACJ,IAAI;YACF,MAAM,YAAY,OAAO,MAAM,CAAC,KAAK,CAAC;YACtC,IAAI,WAAW;gBACb,MAAM,SAAS,KAAK,KAAK,CAAC,SAAS,CAAC,EAAE;gBACtC,WAAW;oBACT,UAAU,OAAO,SAAS;oBAC1B,YAAY,OAAO,WAAW;oBAC9B,cAAc,OAAO,cAAc;oBACnC,WAAW,OAAO,UAAU;oBAC5B,OAAO,OAAO,KAAK,GAAG;wBACpB,aAAa,OAAO,KAAK,CAAC,YAAY;wBACtC,cAAc,OAAO,KAAK,CAAC,aAAa;wBACxC,sBAAsB,OAAO,KAAK,CAAC,uBAAuB;wBAC1D,0BAA0B,OAAO,KAAK,CAAC,2BAA2B;oBACpE,IAAI;gBACN;YACF;QACF,EAAE,OAAM;QACN,oEAAoE;QACtE;QAEA,OAAO;YACL,SAAS;YACT,QAAQ,OAAO,MAAM;YACrB,QAAQ,OAAO,MAAM;YACrB,UAAU,OAAO,QAAQ;YACzB;YACA;QACF;IACF,SAAU;QACR,MAAM,QAAQ,IAAI;IACpB;AACF"}},
    {"offset": {"line": 316, "column": 0}, "map": {"version":3,"sources":["file:///Users/prestondinh/SICC/mvp/app/api/gap-analysis/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\nimport { executeInE2B } from \"@/lib/e2b-executor\";\n\n// Extend Vercel function timeout (3 phases x 2 min each + buffer)\nexport const maxDuration = 600;\n\ninterface IntakeData {\n  estatePlan: { stateOfResidence?: string };\n  personal?: { data: string };\n  family?: { data: string };\n  assets?: { data: string };\n  existingDocuments?: { data: string };\n  goals?: { data: string };\n  beneficiaryDesignations?: BeneficiaryDesignation[];\n}\n\ninterface BeneficiaryDesignation {\n  assetType: string;\n  assetName: string;\n  institution?: string;\n  estimatedValue?: string;\n  primaryBeneficiaryName: string;\n  primaryBeneficiaryRelationship?: string;\n  primaryBeneficiaryPercentage?: number;\n  contingentBeneficiaryName?: string;\n  contingentBeneficiaryRelationship?: string;\n  contingentBeneficiaryPercentage?: number;\n  lastReviewedDate?: string;\n  notes?: string;\n}\n\ninterface ParsedIntake {\n  state: string;\n  personal: Record<string, unknown>;\n  family: Record<string, unknown>;\n  assets: Record<string, unknown>;\n  existingDocs: Record<string, unknown>;\n  goals: Record<string, unknown>;\n  beneficiaries: BeneficiaryDesignation[];\n}\n\nfunction parseIntakeData(intakeData: IntakeData): ParsedIntake {\n  const state = intakeData.estatePlan?.stateOfResidence || \"Unknown\";\n  let personal = {};\n  let family = {};\n  let assets = {};\n  let existingDocs = {};\n  let goals = {};\n\n  try {\n    if (intakeData.personal?.data) personal = JSON.parse(intakeData.personal.data);\n    if (intakeData.family?.data) family = JSON.parse(intakeData.family.data);\n    if (intakeData.assets?.data) assets = JSON.parse(intakeData.assets.data);\n    if (intakeData.existingDocuments?.data) existingDocs = JSON.parse(intakeData.existingDocuments.data);\n    if (intakeData.goals?.data) goals = JSON.parse(intakeData.goals.data);\n  } catch (e) {\n    console.error(\"Error parsing intake data:\", e);\n  }\n\n  return {\n    state,\n    personal,\n    family,\n    assets,\n    existingDocs,\n    goals,\n    beneficiaries: intakeData.beneficiaryDesignations || [],\n  };\n}\n\n// Helper to normalize yes/no/true/false to boolean\nfunction toBool(value: unknown): boolean {\n  if (typeof value === 'boolean') return value;\n  if (typeof value === 'string') {\n    const lower = value.toLowerCase();\n    return lower === 'yes' || lower === 'true' || lower === '1';\n  }\n  return !!value;\n}\n\n// Sophisticated scoring system based on multiple weighted criteria\nfunction calculateScore(parsed: ParsedIntake, analysisResult: Record<string, unknown>): number {\n  let score = 100; // Start with perfect score and deduct\n\n  // Handle both boolean and string \"yes\"/\"no\" values\n  const existingDocs = parsed.existingDocs as Record<string, unknown>;\n  const hasWill = toBool(existingDocs?.hasWill);\n  const hasTrust = toBool(existingDocs?.hasTrust);\n  const hasPOAFinancial = toBool(existingDocs?.hasPOAFinancial);\n  const hasPOAHealthcare = toBool(existingDocs?.hasPOAHealthcare);\n  const hasHealthcareDirective = toBool(existingDocs?.hasHealthcareDirective);\n\n  const hasMinorChildren = (parsed.family as { children?: Array<{ isMinor?: boolean }> })?.children?.some(c => c.isMinor);\n  const estimatedValue = (parsed.assets as { estimatedTotalValue?: number })?.estimatedTotalValue || 0;\n  const isMarried = (parsed.personal as { maritalStatus?: string })?.maritalStatus === \"married\";\n\n  // Core documents (40 points total)\n  if (!hasWill) score -= 15; // Will is essential\n  if (!hasPOAFinancial) score -= 10; // Financial POA critical for incapacity\n  if (!hasPOAHealthcare) score -= 8; // Healthcare POA critical\n  if (!hasHealthcareDirective) score -= 7; // Living will important\n\n  // Trust consideration (15 points) - more important for higher estates\n  if (!hasTrust) {\n    if (estimatedValue > 1000000) score -= 15; // High value estates need trust\n    else if (estimatedValue > 500000) score -= 10;\n    else if (estimatedValue > 100000) score -= 5;\n  }\n\n  // Minor children considerations (15 points)\n  if (hasMinorChildren) {\n    const hasGuardian = (parsed.family as { guardian?: string })?.guardian;\n    if (!hasGuardian) score -= 10; // Guardian nomination critical\n    if (!hasWill) score -= 5; // Will even more important with minors\n  }\n\n  // Beneficiary alignment (10 points)\n  if (parsed.beneficiaries.length === 0 && estimatedValue > 50000) {\n    score -= 10; // Should track beneficiary designations\n  }\n\n  // Marital considerations (10 points)\n  if (isMarried) {\n    if (!hasWill && !hasTrust) score -= 5; // Married couples need estate docs\n    if (estimatedValue > 500000 && !hasTrust) score -= 5; // Consider trust for asset protection\n  }\n\n  // State-specific compliance (5 points)\n  // Deduct if in high-cost probate state without trust\n  const highProbateStates = [\"CA\", \"California\", \"NY\", \"New York\", \"FL\", \"Florida\"];\n  if (highProbateStates.includes(parsed.state) && !hasTrust && estimatedValue > 100000) {\n    score -= 5;\n  }\n\n  // Document currency (5 points) - from analysis result\n  const outdatedDocs = analysisResult?.outdatedDocuments as Array<unknown> || [];\n  if (outdatedDocs.length > 0) {\n    score -= Math.min(5, outdatedDocs.length * 2);\n  }\n\n  // Ensure score stays in valid range\n  return Math.max(0, Math.min(100, Math.round(score)));\n}\n\n// Helper to get parsed client info for prompts\nfunction getClientContext(parsed: ParsedIntake): {\n  hasWill: boolean;\n  hasTrust: boolean;\n  hasPOAFinancial: boolean;\n  hasPOAHealthcare: boolean;\n  hasMinorChildren: boolean;\n  estimatedValue: number;\n  isMarried: boolean;\n} {\n  const existingDocs = parsed.existingDocs as Record<string, unknown>;\n  const hasWill = toBool(existingDocs?.hasWill);\n  const hasTrust = toBool(existingDocs?.hasTrust);\n  const hasPOAFinancial = toBool(existingDocs?.hasPOAFinancial);\n  const hasPOAHealthcare = toBool(existingDocs?.hasPOAHealthcare);\n  const hasMinorChildren = !!(parsed.family as { children?: Array<{ isMinor?: boolean }> })?.children?.some(c => c.isMinor);\n\n  let estimatedValue = 0;\n  const assetsData = parsed.assets as Record<string, unknown>;\n  const rawValue = assetsData?.estimatedTotalValue || assetsData?.totalEstateValue;\n  if (typeof rawValue === 'number') {\n    estimatedValue = rawValue;\n  } else if (typeof rawValue === 'string') {\n    const valueMap: Record<string, number> = {\n      'under_100k': 50000, '100k_500k': 300000, '500k_1m': 750000,\n      '1m_2m': 1500000, '2m_5m': 3500000, '5m_plus': 7500000\n    };\n    estimatedValue = valueMap[rawValue] || parseInt(rawValue.replace(/[^0-9]/g, '')) || 0;\n  }\n\n  const isMarried = (parsed.personal as { maritalStatus?: string })?.maritalStatus === \"married\";\n\n  return { hasWill, hasTrust, hasPOAFinancial, hasPOAHealthcare, hasMinorChildren, estimatedValue, isMarried };\n}\n\n// Single comprehensive prompt - runs in one sandbox session\nfunction buildAnalysisPrompt(parsed: ParsedIntake): string {\n  const ctx = getClientContext(parsed);\n\n  return `You are an expert ${parsed.state} estate planning attorney. Analyze this client and write a comprehensive JSON report.\n\n## CLIENT PROFILE\n- State: ${parsed.state}\n- Marital Status: ${ctx.isMarried ? \"Married\" : \"Single\"}\n- Estate Value: $${ctx.estimatedValue.toLocaleString()}\n- Minor Children: ${ctx.hasMinorChildren ? \"Yes\" : \"No\"}\n\n## CURRENT DOCUMENTS\n- Will: ${ctx.hasWill ? \"YES\" : \"NO - CRITICAL GAP\"}\n- Trust: ${ctx.hasTrust ? \"YES\" : \"NO\"}\n- Financial POA: ${ctx.hasPOAFinancial ? \"YES\" : \"NO - CRITICAL GAP\"}\n- Healthcare POA: ${ctx.hasPOAHealthcare ? \"YES\" : \"NO - CRITICAL GAP\"}\n\n## CLIENT DATA\n${JSON.stringify({ personal: parsed.personal, family: parsed.family, assets: parsed.assets, goals: parsed.goals }, null, 2)}\n\n## YOUR TASK\nWrite a JSON file to /home/user/generated/analysis.json with this structure:\n\n{\n  \"overallScore\": {\n    \"score\": <number 0-100>,\n    \"grade\": \"<A/B/C/D/F>\",\n    \"summary\": \"<2-3 sentence assessment>\"\n  },\n  \"missingDocuments\": [\n    {\n      \"document\": \"<full document name>\",\n      \"priority\": \"<critical/high/medium>\",\n      \"reason\": \"<why essential for THIS client - 2-3 sentences>\",\n      \"consequences\": \"<specific ${parsed.state} legal/financial consequences>\",\n      \"estimatedCostToCreate\": {\"low\": <number>, \"high\": <number>},\n      \"stateRequirements\": \"<${parsed.state} execution requirements>\"\n    }\n  ],\n  \"financialExposure\": {\n    \"estimatedProbateCost\": {\n      \"low\": <number>,\n      \"high\": <number>,\n      \"methodology\": \"<${parsed.state} statutory fee calculation showing math>\",\n      \"statutoryBasis\": \"<cite ${parsed.state} probate code>\"\n    },\n    \"estimatedEstateTax\": {\"federal\": <number>, \"state\": <number>}\n  },\n  \"taxStrategies\": [\n    {\n      \"strategy\": \"<name>\",\n      \"applicability\": \"<why relevant to THIS client>\",\n      \"estimatedSavings\": {\"low\": <number>, \"high\": <number>},\n      \"implementationSteps\": [\"<step1>\", \"<step2>\", \"<step3>\"]\n    }\n  ],\n  \"stateSpecificConsiderations\": [\n    {\n      \"topic\": \"<legal topic>\",\n      \"rule\": \"<${parsed.state} specific rule>\",\n      \"impact\": \"<how it affects THIS client>\",\n      \"action\": \"<what to do>\",\n      \"citation\": \"<${parsed.state} statute>\"\n    }\n  ],\n  \"prioritizedRecommendations\": [\n    {\n      \"rank\": <1-10>,\n      \"action\": \"<specific action>\",\n      \"priority\": \"<critical/high/medium>\",\n      \"timeline\": \"<immediate/30-days/90-days>\",\n      \"estimatedCost\": {\"low\": <number>, \"high\": <number>},\n      \"detailedSteps\": [\"<step1>\", \"<step2>\", \"<step3>\", \"<step4>\"],\n      \"riskOfDelay\": \"<consequence of not acting>\"\n    }\n  ],\n  \"executiveSummary\": {\n    \"criticalIssues\": [\"<issue1>\", \"<issue2>\", \"<issue3>\"],\n    \"immediateActions\": [\"<action1>\", \"<action2>\"],\n    \"biggestRisks\": [\"<risk1>\", \"<risk2>\", \"<risk3>\"]\n  }\n}\n\n## SCORING GUIDE\nStart at 100, deduct: No Will=-15, No Trust(>$500K)=-10, No FinPOA=-10, No HealthPOA=-8, Minor children no guardian=-10\n\n## REQUIREMENTS\n- Include 4-6 missing documents with detailed ${parsed.state}-specific consequences\n- Calculate exact ${parsed.state} probate fees with statutory citations\n- Provide 3-5 tax strategies with implementation steps\n- List 5-7 ${parsed.state}-specific legal considerations with statute citations\n- Give 8-10 prioritized recommendations with detailed steps\n\nWrite the complete JSON file now.`;\n}\n\n// Attempt to repair truncated JSON by closing open brackets\nfunction repairJSON(json: string): string {\n  let repaired = json.trim();\n\n  // Remove trailing incomplete key-value pairs (e.g., `\"key\":` or `\"key\": \"incomplete`)\n  // Look for patterns at the end that indicate truncation\n  repaired = repaired.replace(/,\\s*\"[^\"]*\":\\s*\"?[^\",}\\]]*$/, '');\n  repaired = repaired.replace(/,\\s*\"[^\"]*\":\\s*$/, '');\n  repaired = repaired.replace(/,\\s*\"[^\"]*$/, '');\n  repaired = repaired.replace(/,\\s*$/, '');\n\n  // Count open brackets\n  let openBraces = 0;\n  let openBrackets = 0;\n  let inString = false;\n  let escapeNext = false;\n\n  for (const char of repaired) {\n    if (escapeNext) {\n      escapeNext = false;\n      continue;\n    }\n    if (char === '\\\\') {\n      escapeNext = true;\n      continue;\n    }\n    if (char === '\"') {\n      inString = !inString;\n      continue;\n    }\n    if (!inString) {\n      if (char === '{') openBraces++;\n      if (char === '}') openBraces--;\n      if (char === '[') openBrackets++;\n      if (char === ']') openBrackets--;\n    }\n  }\n\n  // If we're in a string, close it\n  if (inString) {\n    repaired += '\"';\n  }\n\n  // Close any open brackets/braces\n  while (openBrackets > 0) {\n    repaired += ']';\n    openBrackets--;\n  }\n  while (openBraces > 0) {\n    repaired += '}';\n    openBraces--;\n  }\n\n  return repaired;\n}\n\nfunction extractJSON(result: { stdout?: string; fileContent?: string }): Record<string, unknown> | null {\n  console.log(\"extractJSON called, fileContent length:\", result.fileContent?.length || 0, \"stdout length:\", result.stdout?.length || 0);\n\n  // Try file content first (most reliable)\n  if (result.fileContent && result.fileContent.trim()) {\n    // First try direct parse\n    try {\n      const parsed = JSON.parse(result.fileContent);\n      console.log(\"Successfully parsed fileContent, keys:\", Object.keys(parsed));\n      return parsed;\n    } catch (e) {\n      console.error(\"Failed to parse fileContent:\", e);\n      console.error(\"fileContent preview:\", result.fileContent.substring(0, 500));\n\n      // Try to repair truncated JSON\n      try {\n        const repaired = repairJSON(result.fileContent);\n        const parsed = JSON.parse(repaired);\n        console.log(\"Successfully parsed REPAIRED fileContent, keys:\", Object.keys(parsed));\n        return parsed;\n      } catch (repairError) {\n        console.error(\"Failed to repair JSON:\", repairError);\n      }\n    }\n  }\n\n  // Try to extract from stdout\n  if (result.stdout) {\n    // Try code block first\n    const codeBlockMatch = result.stdout.match(/```(?:json)?\\s*\\n([\\s\\S]*?)\\n```/);\n    if (codeBlockMatch) {\n      try {\n        const parsed = JSON.parse(codeBlockMatch[1]);\n        console.log(\"Successfully parsed code block JSON, keys:\", Object.keys(parsed));\n        return parsed;\n      } catch (e) {\n        console.error(\"Failed to parse code block JSON:\", e);\n      }\n    }\n\n    // Try to find raw JSON object - look for analysis.json content pattern\n    const analysisMatch = result.stdout.match(/\\{\"overallScore\"[\\s\\S]*\\}(?=\\s*$|\\s*\\n\\s*===)/);\n    if (analysisMatch) {\n      try {\n        const parsed = JSON.parse(analysisMatch[0]);\n        console.log(\"Successfully parsed analysis JSON from stdout, keys:\", Object.keys(parsed));\n        return parsed;\n      } catch (e) {\n        console.error(\"Failed to parse analysis JSON:\", e);\n      }\n    }\n\n    // Fallback: Try to find any large JSON object\n    const jsonStart = result.stdout.indexOf('{\"overallScore\"');\n    if (jsonStart !== -1) {\n      // Find the matching closing brace\n      let braceCount = 0;\n      let jsonEnd = -1;\n      for (let i = jsonStart; i < result.stdout.length; i++) {\n        if (result.stdout[i] === '{') braceCount++;\n        if (result.stdout[i] === '}') {\n          braceCount--;\n          if (braceCount === 0) {\n            jsonEnd = i;\n            break;\n          }\n        }\n      }\n      if (jsonEnd !== -1) {\n        try {\n          const parsed = JSON.parse(result.stdout.substring(jsonStart, jsonEnd + 1));\n          console.log(\"Successfully parsed JSON with brace matching, keys:\", Object.keys(parsed));\n          return parsed;\n        } catch (e) {\n          console.error(\"Failed to parse JSON with brace matching:\", e);\n        }\n      }\n    }\n  }\n\n  console.error(\"extractJSON: No valid JSON found\");\n  return null;\n}\n\nexport async function POST(req: Request) {\n  try {\n    const { intakeData } = await req.json();\n\n    if (!intakeData) {\n      return NextResponse.json({ error: \"Intake data is required\" }, { status: 400 });\n    }\n\n    // Parse the intake data\n    const parsed = parseIntakeData(intakeData);\n    const ctx = getClientContext(parsed);\n\n    console.log(\"Starting gap analysis...\");\n    console.log(\"Client context:\", JSON.stringify(ctx));\n\n    // Build and execute single comprehensive prompt\n    const prompt = buildAnalysisPrompt(parsed);\n    const result = await executeInE2B({\n      prompt,\n      outputFile: \"analysis.json\",\n      timeoutMs: 600000, // 10 minutes\n    });\n\n    console.log(\"E2B result:\", {\n      success: result.success,\n      hasFileContent: !!result.fileContent,\n      fileContentLength: result.fileContent?.length,\n      error: result.error,\n    });\n\n    if (!result.success) {\n      throw new Error(result.error || \"E2B execution failed\");\n    }\n\n    // Extract JSON from result\n    let analysisResult = extractJSON(result);\n\n    // Calculate and validate score\n    const calculatedScore = calculateScore(parsed, analysisResult || {});\n\n    if (analysisResult) {\n      if (analysisResult.overallScore && typeof analysisResult.overallScore === 'object') {\n        const overallScore = analysisResult.overallScore as Record<string, unknown>;\n        const aiScore = typeof overallScore.score === 'number' ? overallScore.score : calculatedScore;\n        overallScore.score = Math.round((aiScore * 0.7) + (calculatedScore * 0.3));\n        overallScore.calculatedScore = calculatedScore;\n        overallScore.aiGeneratedScore = aiScore;\n      } else {\n        analysisResult.overallScore = {\n          score: calculatedScore,\n          grade: calculatedScore >= 90 ? 'A' : calculatedScore >= 80 ? 'B' : calculatedScore >= 70 ? 'C' : calculatedScore >= 60 ? 'D' : 'F',\n          summary: \"Score calculated based on document completeness and estate planning best practices.\"\n        };\n      }\n      analysisResult.score = (analysisResult.overallScore as Record<string, unknown>).score;\n    } else {\n      // Fallback if parsing failed\n      analysisResult = {\n        score: calculatedScore,\n        overallScore: {\n          score: calculatedScore,\n          grade: calculatedScore >= 90 ? 'A' : calculatedScore >= 80 ? 'B' : calculatedScore >= 70 ? 'C' : calculatedScore >= 60 ? 'D' : 'F',\n          summary: \"Analysis completed. Please review the details below.\"\n        },\n        missingDocuments: [],\n        outdatedDocuments: [],\n        inconsistencies: [],\n        taxStrategies: [],\n        stateSpecificConsiderations: [],\n        prioritizedRecommendations: [],\n        executiveSummary: { criticalIssues: [], immediateActions: [], biggestRisks: [] },\n      };\n    }\n\n    // Ensure arrays exist\n    analysisResult.missingDocuments = analysisResult.missingDocuments || [];\n    analysisResult.outdatedDocuments = analysisResult.outdatedDocuments || [];\n    analysisResult.inconsistencies = analysisResult.inconsistencies || [];\n    analysisResult.taxStrategies = analysisResult.taxStrategies || [];\n    analysisResult.stateSpecificConsiderations = analysisResult.stateSpecificConsiderations || [];\n    analysisResult.prioritizedRecommendations = analysisResult.prioritizedRecommendations || [];\n\n    console.log(\"Final analysis:\", {\n      score: analysisResult.score,\n      missingDocsCount: (analysisResult.missingDocuments as unknown[]).length,\n      recommendationsCount: (analysisResult.prioritizedRecommendations as unknown[]).length,\n      stateNotesCount: (analysisResult.stateSpecificConsiderations as unknown[]).length,\n    });\n\n    return NextResponse.json({\n      success: true,\n      analysisResult,\n      stdout: result.stdout,\n    });\n\n  } catch (error) {\n    console.error(\"Gap analysis error:\", error);\n    return NextResponse.json(\n      {\n        success: false,\n        error: error instanceof Error ? error.message : \"Unknown error\"\n      },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":"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"}}]
}