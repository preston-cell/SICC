{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 76, "column": 0}, "map": {"version":3,"sources":["file:///Users/prestondinh/SICC/mvp/lib/e2b-executor.ts"],"sourcesContent":["import { Sandbox } from \"e2b\";\n\n// Skills content\nconst SKILLS = {\n  \"estate-document-analyzer\": {\n    \"SKILL.md\": `# Estate Document Analyzer Skill\n\nYou are an expert estate planning document analyzer. When given estate planning documents (wills, trusts, POAs, etc.), you:\n\n1. **Extract Key Information**:\n   - Document type and date\n   - Principal/grantor name\n   - Named parties (executors, trustees, agents, beneficiaries)\n   - Key provisions and terms\n\n2. **Identify Issues**:\n   - Missing signatures or witnesses\n   - Outdated information\n   - Ambiguous language\n   - Potential conflicts with other documents\n\n3. **Provide Recommendations**:\n   - Suggest updates needed\n   - Flag inconsistencies\n   - Note state-specific compliance issues\n\nOutput format: JSON with sections for extracted_info, issues, and recommendations.`\n  },\n  \"estate-goals-profiler\": {\n    \"SKILL.md\": `# Estate Goals Profiler Skill\n\nYou help clients articulate and prioritize their estate planning goals. You:\n\n1. **Identify Goals**:\n   - Asset protection\n   - Tax minimization\n   - Family provision\n   - Charitable giving\n   - Business succession\n   - Healthcare directives\n\n2. **Assess Priorities**:\n   - Rank goals by importance\n   - Identify potential conflicts\n   - Suggest compromise solutions\n\n3. **Recommend Documents**:\n   - Map goals to specific documents needed\n   - Prioritize document creation order\n\nOutput format: JSON with prioritized_goals, conflicts, and document_recommendations.`\n  },\n  \"financial-profile-classifier\": {\n    \"SKILL.md\": `# Financial Profile Classifier Skill\n\nYou analyze financial situations for estate planning purposes. You:\n\n1. **Classify Estate Size**:\n   - Simple (under $1M)\n   - Moderate ($1M - $5M)\n   - Complex ($5M - $12M)\n   - High Net Worth ($12M+)\n\n2. **Identify Tax Implications**:\n   - Federal estate tax exposure\n   - State estate/inheritance tax\n   - Gift tax considerations\n   - Generation-skipping tax\n\n3. **Recommend Strategies**:\n   - Basic will vs. living trust\n   - Irrevocable trust options\n   - Charitable planning\n   - Life insurance planning\n\nOutput format: JSON with classification, tax_exposure, and strategy_recommendations.`\n  },\n  \"us-estate-planning-analyzer\": {\n    \"SKILL.md\": `# US Estate Planning Analyzer Skill\n\nYou are an expert in US estate planning law. You analyze estate plans for:\n\n1. **Federal Compliance**:\n   - Estate tax exemption limits (current: $13.61M per person)\n   - Gift tax annual exclusion ($18,000 per recipient)\n   - Portability elections\n   - QTIP trust requirements\n\n2. **State-Specific Rules**:\n   - Community property vs. common law states\n   - State estate tax thresholds\n   - State inheritance taxes\n   - Homestead exemptions\n\n3. **Document Requirements**:\n   - Will execution requirements by state\n   - Trust formation rules\n   - POA statutory forms\n   - Healthcare directive compliance\n\n4. **Gap Analysis**:\n   - Missing essential documents\n   - Outdated provisions\n   - Beneficiary inconsistencies\n   - Tax optimization opportunities\n\nOutput format: JSON with compliance_status, state_specific_issues, gaps, and recommendations.`\n  }\n};\n\nconst OUTPUT_DIR = \"/home/user/generated\";\nconst SKILLS_DIR = \"/home/user/.claude/skills\";\n\nexport interface E2BExecuteResult {\n  success: boolean;\n  stdout?: string;\n  stderr?: string;\n  exitCode?: number;\n  fileContent?: string;\n  error?: string;\n  // Metadata from --output-format json\n  metadata?: {\n    numTurns?: number;\n    durationMs?: number;\n    totalCostUsd?: number;\n    sessionId?: string;\n    usage?: {\n      inputTokens?: number;\n      outputTokens?: number;\n      cacheReadInputTokens?: number;\n      cacheCreationInputTokens?: number;\n    };\n  };\n}\n\nexport interface E2BExecuteOptions {\n  prompt: string;\n  outputFile?: string;\n  timeoutMs?: number;\n}\n\n/**\n * Execute Claude Code in E2B sandbox\n * This is a shared function that can be called directly without HTTP\n */\nexport async function executeInE2B(options: E2BExecuteOptions): Promise<E2BExecuteResult> {\n  const { prompt, outputFile, timeoutMs = 240000 } = options;\n\n  const E2B_API_KEY = process.env.E2B_API_KEY;\n  const ANTHROPIC_API_KEY = process.env.ANTHROPIC_API_KEY;\n\n  if (!E2B_API_KEY || !ANTHROPIC_API_KEY) {\n    return { success: false, error: \"API keys not configured\" };\n  }\n\n  // Create sandbox with very long timeout for comprehensive analysis\n  const sandbox = await Sandbox.create(\"base\", {\n    timeoutMs: 1800000, // 30 minutes sandbox lifetime\n    apiKey: E2B_API_KEY,\n  });\n\n  try {\n    // Create directories\n    await sandbox.commands.run(`mkdir -p ${OUTPUT_DIR}`);\n    await sandbox.commands.run(`mkdir -p ${SKILLS_DIR}`);\n\n    // Inject skills\n    for (const [skillName, files] of Object.entries(SKILLS)) {\n      const skillDir = `${SKILLS_DIR}/${skillName}`;\n      await sandbox.commands.run(`mkdir -p \"${skillDir}\"`);\n      for (const [fileName, content] of Object.entries(files)) {\n        await sandbox.files.write(`${skillDir}/${fileName}`, content);\n      }\n    }\n\n    // Create wrapper script\n    const wrapperScript = `\n#!/bin/bash\nset -e\n\ncd ${OUTPUT_DIR}\n\n# Install Claude Code CLI\nnpm install -g @anthropic-ai/claude-code 2>&1 || {\n    echo \"Failed to install claude-code, trying npx...\"\n    export USE_NPX=1\n}\n\n# Create prompt file\ncat > /tmp/prompt.txt << 'PROMPT_EOF'\n${prompt.replace(/'/g, \"'\\\\''\")}\nPROMPT_EOF\n\necho \"=== Starting Claude Code ===\"\necho \"Working directory: $(pwd)\"\necho \"Available skills:\"\nls -la $HOME/.claude/skills/ 2>/dev/null || echo \"(no skills)\"\n\n# Run Claude Code with safety limits and structured output\nif [ \"\\${USE_NPX:-}\" = \"1\" ]; then\n    npx -y @anthropic-ai/claude-code --print --dangerously-skip-permissions --output-format json --max-turns 5 -p \"$(cat /tmp/prompt.txt)\" 2>&1\nelse\n    claude --print --dangerously-skip-permissions --output-format json --max-turns 5 -p \"$(cat /tmp/prompt.txt)\" 2>&1\nfi\n\necho \"\"\necho \"=== Claude Code Finished ===\"\necho \"Generated files:\"\nls -la ${OUTPUT_DIR}/ 2>/dev/null || echo \"(none)\"\n`;\n\n    await sandbox.files.write(\"/tmp/run_claude.sh\", wrapperScript);\n    await sandbox.commands.run(\"chmod +x /tmp/run_claude.sh\");\n\n    // Run Claude Code with very long timeout\n    const result = await sandbox.commands.run(\"bash /tmp/run_claude.sh\", {\n      envs: {\n        ANTHROPIC_API_KEY,\n        HOME: \"/home/user\",\n        CI: \"true\",\n      },\n      timeoutMs: 900000, // 15 minutes per command\n    });\n\n    // Try to read output file if specified\n    let fileContent = \"\";\n    if (outputFile) {\n      try {\n        fileContent = await sandbox.files.read(`${OUTPUT_DIR}/${outputFile}`);\n      } catch {\n        // Try to find any file with similar name\n        const listResult = await sandbox.commands.run(\n          `find ${OUTPUT_DIR} -type f 2>/dev/null || true`\n        );\n        const files = listResult.stdout.split(\"\\n\").filter((f: string) => f.trim());\n        if (files.length > 0) {\n          fileContent = await sandbox.files.read(files[0]);\n        }\n      }\n    }\n\n    // Extract metadata from JSON output (--output-format json)\n    let metadata: E2BExecuteResult[\"metadata\"];\n    try {\n      const jsonMatch = result.stdout.match(/\\{[\\s\\S]*\"num_turns\"[\\s\\S]*\\}/);\n      if (jsonMatch) {\n        const parsed = JSON.parse(jsonMatch[0]);\n        metadata = {\n          numTurns: parsed.num_turns,\n          durationMs: parsed.duration_ms,\n          totalCostUsd: parsed.total_cost_usd,\n          sessionId: parsed.session_id,\n          usage: parsed.usage ? {\n            inputTokens: parsed.usage.input_tokens,\n            outputTokens: parsed.usage.output_tokens,\n            cacheReadInputTokens: parsed.usage.cache_read_input_tokens,\n            cacheCreationInputTokens: parsed.usage.cache_creation_input_tokens,\n          } : undefined,\n        };\n      }\n    } catch {\n      // Metadata extraction is best-effort, don't fail if it doesn't work\n    }\n\n    return {\n      success: true,\n      stdout: result.stdout,\n      stderr: result.stderr,\n      exitCode: result.exitCode,\n      fileContent,\n      metadata,\n    };\n  } finally {\n    await sandbox.kill();\n  }\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 316, "column": 0}, "map": {"version":3,"sources":["file:///Users/prestondinh/SICC/mvp/app/api/e2b/execute/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\nimport { executeInE2B } from \"@/lib/e2b-executor\";\n\n// Extend Vercel function timeout (max 300s on Pro plan, 60s on Hobby)\nexport const maxDuration = 300;\n\ninterface ExecuteRequest {\n  prompt: string;\n  outputFile?: string;\n  timeoutMs?: number;\n}\n\nexport async function POST(req: Request) {\n  try {\n    const body: ExecuteRequest = await req.json();\n    const { prompt, outputFile, timeoutMs = 240000 } = body;\n\n    if (!prompt) {\n      return NextResponse.json({ error: \"Prompt is required\" }, { status: 400 });\n    }\n\n    const result = await executeInE2B({ prompt, outputFile, timeoutMs });\n\n    if (!result.success) {\n      return NextResponse.json(\n        { success: false, error: result.error },\n        { status: 500 }\n      );\n    }\n\n    return NextResponse.json(result);\n  } catch (error) {\n    console.error(\"E2B execution error:\", error);\n    return NextResponse.json(\n      {\n        success: false,\n        error: error instanceof Error ? error.message : \"Unknown error\",\n      },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":";;;;;;AAAA;AACA;;;AAGO,MAAM,cAAc;AAQpB,eAAe,KAAK,GAAY;IACrC,IAAI;QACF,MAAM,OAAuB,MAAM,IAAI,IAAI;QAC3C,MAAM,EAAE,MAAM,EAAE,UAAU,EAAE,YAAY,MAAM,EAAE,GAAG;QAEnD,IAAI,CAAC,QAAQ;YACX,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAqB,GAAG;gBAAE,QAAQ;YAAI;QAC1E;QAEA,MAAM,SAAS,MAAM,IAAA,wIAAY,EAAC;YAAE;YAAQ;YAAY;QAAU;QAElE,IAAI,CAAC,OAAO,OAAO,EAAE;YACnB,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,SAAS;gBAAO,OAAO,OAAO,KAAK;YAAC,GACtC;gBAAE,QAAQ;YAAI;QAElB;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;IAC3B,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,wBAAwB;QACtC,OAAO,gJAAY,CAAC,IAAI,CACtB;YACE,SAAS;YACT,OAAO,iBAAiB,QAAQ,MAAM,OAAO,GAAG;QAClD,GACA;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}