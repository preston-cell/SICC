{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 76, "column": 0}, "map": {"version":3,"sources":["file:///Users/prestondinh/SICC/mvp/app/api/e2b/execute/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\nimport { Sandbox } from \"e2b\";\n\n// Extend Vercel function timeout (max 300s on Pro plan, 60s on Hobby)\nexport const maxDuration = 300;\n\n// Skills content - embedded here for Next.js API route\nconst SKILLS = {\n  \"estate-document-analyzer\": {\n    \"SKILL.md\": `# Estate Document Analyzer Skill\n\nYou are an expert estate planning document analyzer. When given estate planning documents (wills, trusts, POAs, etc.), you:\n\n1. **Extract Key Information**:\n   - Document type and date\n   - Principal/grantor name\n   - Named parties (executors, trustees, agents, beneficiaries)\n   - Key provisions and terms\n\n2. **Identify Issues**:\n   - Missing signatures or witnesses\n   - Outdated information\n   - Ambiguous language\n   - Potential conflicts with other documents\n\n3. **Provide Recommendations**:\n   - Suggest updates needed\n   - Flag inconsistencies\n   - Note state-specific compliance issues\n\nOutput format: JSON with sections for extracted_info, issues, and recommendations.`\n  },\n  \"estate-goals-profiler\": {\n    \"SKILL.md\": `# Estate Goals Profiler Skill\n\nYou help clients articulate and prioritize their estate planning goals. You:\n\n1. **Identify Goals**:\n   - Asset protection\n   - Tax minimization\n   - Family provision\n   - Charitable giving\n   - Business succession\n   - Healthcare directives\n\n2. **Assess Priorities**:\n   - Rank goals by importance\n   - Identify potential conflicts\n   - Suggest compromise solutions\n\n3. **Recommend Documents**:\n   - Map goals to specific documents needed\n   - Prioritize document creation order\n\nOutput format: JSON with prioritized_goals, conflicts, and document_recommendations.`\n  },\n  \"financial-profile-classifier\": {\n    \"SKILL.md\": `# Financial Profile Classifier Skill\n\nYou analyze financial situations for estate planning purposes. You:\n\n1. **Classify Estate Size**:\n   - Simple (under $1M)\n   - Moderate ($1M - $5M)\n   - Complex ($5M - $12M)\n   - High Net Worth ($12M+)\n\n2. **Identify Tax Implications**:\n   - Federal estate tax exposure\n   - State estate/inheritance tax\n   - Gift tax considerations\n   - Generation-skipping tax\n\n3. **Recommend Strategies**:\n   - Basic will vs. living trust\n   - Irrevocable trust options\n   - Charitable planning\n   - Life insurance planning\n\nOutput format: JSON with classification, tax_exposure, and strategy_recommendations.`\n  },\n  \"us-estate-planning-analyzer\": {\n    \"SKILL.md\": `# US Estate Planning Analyzer Skill\n\nYou are an expert in US estate planning law. You analyze estate plans for:\n\n1. **Federal Compliance**:\n   - Estate tax exemption limits (current: $13.61M per person)\n   - Gift tax annual exclusion ($18,000 per recipient)\n   - Portability elections\n   - QTIP trust requirements\n\n2. **State-Specific Rules**:\n   - Community property vs. common law states\n   - State estate tax thresholds\n   - State inheritance taxes\n   - Homestead exemptions\n\n3. **Document Requirements**:\n   - Will execution requirements by state\n   - Trust formation rules\n   - POA statutory forms\n   - Healthcare directive compliance\n\n4. **Gap Analysis**:\n   - Missing essential documents\n   - Outdated provisions\n   - Beneficiary inconsistencies\n   - Tax optimization opportunities\n\nOutput format: JSON with compliance_status, state_specific_issues, gaps, and recommendations.`\n  }\n};\n\n// Environment variables (server-side only)\nconst E2B_API_KEY = process.env.E2B_API_KEY!;\nconst ANTHROPIC_API_KEY = process.env.ANTHROPIC_API_KEY!;\n\nconst OUTPUT_DIR = \"/home/user/generated\";\nconst SKILLS_DIR = \"/home/user/.claude/skills\";\n\ninterface ExecuteRequest {\n  prompt: string;\n  outputFile?: string;\n  timeoutMs?: number;\n}\n\nexport async function POST(req: Request) {\n  try {\n    const body: ExecuteRequest = await req.json();\n    const { prompt, outputFile, timeoutMs = 240000 } = body;\n\n    if (!prompt) {\n      return NextResponse.json({ error: \"Prompt is required\" }, { status: 400 });\n    }\n\n    if (!E2B_API_KEY || !ANTHROPIC_API_KEY) {\n      return NextResponse.json(\n        { error: \"API keys not configured\" },\n        { status: 500 }\n      );\n    }\n\n    // Create sandbox with extended timeout for comprehensive analysis\n    const sandbox = await Sandbox.create(\"base\", {\n      timeoutMs: 600000, // 10 minutes for sandbox lifetime\n      apiKey: E2B_API_KEY,\n    });\n\n    try {\n      // Create directories\n      await sandbox.commands.run(`mkdir -p ${OUTPUT_DIR}`);\n      await sandbox.commands.run(`mkdir -p ${SKILLS_DIR}`);\n\n      // Inject skills\n      for (const [skillName, files] of Object.entries(SKILLS)) {\n        const skillDir = `${SKILLS_DIR}/${skillName}`;\n        await sandbox.commands.run(`mkdir -p \"${skillDir}\"`);\n        for (const [fileName, content] of Object.entries(files)) {\n          await sandbox.files.write(`${skillDir}/${fileName}`, content);\n        }\n      }\n\n      // Create wrapper script\n      const wrapperScript = `\n#!/bin/bash\nset -e\n\ncd ${OUTPUT_DIR}\n\n# Install Claude Code CLI\nnpm install -g @anthropic-ai/claude-code 2>&1 || {\n    echo \"Failed to install claude-code, trying npx...\"\n    export USE_NPX=1\n}\n\n# Create prompt file\ncat > /tmp/prompt.txt << 'PROMPT_EOF'\n${prompt.replace(/'/g, \"'\\\\''\")}\nPROMPT_EOF\n\necho \"=== Starting Claude Code ===\"\necho \"Working directory: $(pwd)\"\necho \"Available skills:\"\nls -la $HOME/.claude/skills/ 2>/dev/null || echo \"(no skills)\"\n\n# Run Claude Code\nif [ \"\\${USE_NPX:-}\" = \"1\" ]; then\n    npx -y @anthropic-ai/claude-code --print --dangerously-skip-permissions -p \"$(cat /tmp/prompt.txt)\" 2>&1\nelse\n    claude --print --dangerously-skip-permissions -p \"$(cat /tmp/prompt.txt)\" 2>&1\nfi\n\necho \"\"\necho \"=== Claude Code Finished ===\"\necho \"Generated files:\"\nls -la ${OUTPUT_DIR}/ 2>/dev/null || echo \"(none)\"\n`;\n\n      await sandbox.files.write(\"/tmp/run_claude.sh\", wrapperScript);\n      await sandbox.commands.run(\"chmod +x /tmp/run_claude.sh\");\n\n      // Run Claude Code\n      const result = await sandbox.commands.run(\"bash /tmp/run_claude.sh\", {\n        envs: {\n          ANTHROPIC_API_KEY,\n          HOME: \"/home/user\",\n          CI: \"true\",\n        },\n        timeoutMs,\n      });\n\n      // Try to read output file if specified\n      let fileContent = \"\";\n      if (outputFile) {\n        try {\n          fileContent = await sandbox.files.read(`${OUTPUT_DIR}/${outputFile}`);\n        } catch {\n          // Try to find any file with similar name\n          const listResult = await sandbox.commands.run(\n            `find ${OUTPUT_DIR} -type f 2>/dev/null || true`\n          );\n          const files = listResult.stdout.split(\"\\n\").filter((f: string) => f.trim());\n          if (files.length > 0) {\n            fileContent = await sandbox.files.read(files[0]);\n          }\n        }\n      }\n\n      return NextResponse.json({\n        success: true,\n        stdout: result.stdout,\n        stderr: result.stderr,\n        exitCode: result.exitCode,\n        fileContent,\n      });\n    } finally {\n      await sandbox.kill();\n    }\n  } catch (error) {\n    console.error(\"E2B execution error:\", error);\n    return NextResponse.json(\n      {\n        success: false,\n        error: error instanceof Error ? error.message : \"Unknown error\",\n      },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":"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"}}]
}