{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/prestondinh/SICC/mvp/app/api/gap-analysis/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\n\n// Extend Vercel function timeout\nexport const maxDuration = 300;\n\nconst E2B_API_URL = \"/api/e2b/execute\";\n\ninterface IntakeData {\n  estatePlan: { stateOfResidence?: string };\n  personal?: { data: string };\n  family?: { data: string };\n  assets?: { data: string };\n  existingDocuments?: { data: string };\n  goals?: { data: string };\n  beneficiaryDesignations?: BeneficiaryDesignation[];\n}\n\ninterface BeneficiaryDesignation {\n  assetType: string;\n  assetName: string;\n  institution?: string;\n  estimatedValue?: string;\n  primaryBeneficiaryName: string;\n  primaryBeneficiaryRelationship?: string;\n  primaryBeneficiaryPercentage?: number;\n  contingentBeneficiaryName?: string;\n  contingentBeneficiaryRelationship?: string;\n  contingentBeneficiaryPercentage?: number;\n  lastReviewedDate?: string;\n  notes?: string;\n}\n\n// Build the analysis prompt from intake data\nfunction buildAnalysisPrompt(intakeData: IntakeData): string {\n  const state = intakeData.estatePlan?.stateOfResidence || \"Unknown\";\n\n  let personalData = {};\n  let familyData = {};\n  let assetsData = {};\n  let existingDocsData = {};\n  let goalsData = {};\n\n  try {\n    if (intakeData.personal?.data) personalData = JSON.parse(intakeData.personal.data);\n    if (intakeData.family?.data) familyData = JSON.parse(intakeData.family.data);\n    if (intakeData.assets?.data) assetsData = JSON.parse(intakeData.assets.data);\n    if (intakeData.existingDocuments?.data) existingDocsData = JSON.parse(intakeData.existingDocuments.data);\n    if (intakeData.goals?.data) goalsData = JSON.parse(intakeData.goals.data);\n  } catch (e) {\n    console.error(\"Error parsing intake data:\", e);\n  }\n\n  const beneficiaryData = intakeData.beneficiaryDesignations || [];\n\n  return `You are an expert estate planning analyst using the us-estate-planning-analyzer skill.\n\nPerform a comprehensive gap analysis of the following estate planning data.\n\nSTATE OF RESIDENCE: ${state}\n\n=== INTAKE DATA ===\n\nPERSONAL INFORMATION:\n${JSON.stringify(personalData, null, 2)}\n\nFAMILY INFORMATION:\n${JSON.stringify(familyData, null, 2)}\n\nASSETS OVERVIEW:\n${JSON.stringify(assetsData, null, 2)}\n\nBENEFICIARY DESIGNATIONS (accounts that bypass the will):\n${beneficiaryData.length > 0 ? JSON.stringify(beneficiaryData, null, 2) : \"No beneficiary designations tracked\"}\n\nEXISTING DOCUMENTS:\n${JSON.stringify(existingDocsData, null, 2)}\n\nGOALS AND WISHES:\n${JSON.stringify(goalsData, null, 2)}\n\n=== ANALYSIS REQUIREMENTS ===\n\nAnalyze this estate plan comprehensively. Consider:\n\n1. **Missing Documents**: What essential documents are missing based on their situation?\n   - Will, Trust, POAs (financial & healthcare), Healthcare Directive, HIPAA\n   - Consider family situation (minor children need guardian nominations)\n   - Consider asset complexity (high value may need trust)\n\n2. **Outdated Documents**: Any documents created more than 5 years ago?\n\n3. **Inconsistencies**: Conflicts between stated goals and existing documents?\n   - Beneficiary designations vs. will provisions\n   - Ex-spouse still named on accounts?\n   - Children from previous marriage not included?\n\n4. **State-Specific Issues**: Requirements specific to ${state}\n\n5. **Tax Planning**: Based on estate value, any tax optimization strategies?\n\n6. **Beneficiary Conflicts**: Do retirement/insurance beneficiaries match will intentions?\n\n=== OUTPUT FORMAT ===\n\nSave your analysis as JSON to: /home/user/generated/analysis.json\n\nUse this exact format:\n{\n  \"score\": <number 0-100 representing estate plan completeness>,\n  \"estateComplexity\": \"<low, moderate, or high>\",\n  \"estimatedEstateTax\": {\n    \"state\": <estimated state estate tax in dollars>,\n    \"federal\": <estimated federal estate tax in dollars>,\n    \"notes\": \"<explanation>\"\n  },\n  \"missingDocuments\": [\n    {\n      \"type\": \"<document type>\",\n      \"priority\": \"<high, medium, or low>\",\n      \"reason\": \"<why this document is needed>\",\n      \"estimatedImpact\": \"<dollar impact if applicable>\"\n    }\n  ],\n  \"outdatedDocuments\": [\n    {\n      \"type\": \"<document type>\",\n      \"issue\": \"<what's outdated>\",\n      \"recommendation\": \"<what should be done>\"\n    }\n  ],\n  \"inconsistencies\": [\n    {\n      \"issue\": \"<describe the inconsistency>\",\n      \"details\": \"<specifics>\",\n      \"recommendation\": \"<how to resolve>\"\n    }\n  ],\n  \"taxOptimization\": [\n    {\n      \"strategy\": \"<strategy name>\",\n      \"applicability\": \"<why this applies>\",\n      \"estimatedSavings\": \"<dollar amount>\",\n      \"complexity\": \"<conservative, moderate, or advanced>\",\n      \"priority\": \"<high, medium, or low>\"\n    }\n  ],\n  \"medicaidPlanning\": {\n    \"atRisk\": <boolean>,\n    \"concerns\": [\"<list of concerns>\"],\n    \"recommendations\": [\"<recommendations>\"],\n    \"lookbackIssues\": [\"<5-year look-back concerns>\"]\n  },\n  \"recommendations\": [\n    {\n      \"action\": \"<specific action to take>\",\n      \"priority\": \"<high, medium, or low>\",\n      \"reason\": \"<why this is important>\",\n      \"estimatedImpact\": \"<dollar impact if calculable>\"\n    }\n  ],\n  \"stateSpecificNotes\": [\n    {\n      \"note\": \"<state-specific consideration>\",\n      \"relevance\": \"<why this matters>\",\n      \"citation\": \"<legal citation if applicable>\"\n    }\n  ]\n}\n\nPerform the analysis now and save the results.`;\n}\n\nexport async function POST(req: Request) {\n  try {\n    const { intakeData } = await req.json();\n\n    if (!intakeData) {\n      return NextResponse.json({ error: \"Intake data is required\" }, { status: 400 });\n    }\n\n    // Build the prompt\n    const prompt = buildAnalysisPrompt(intakeData);\n\n    // Get the base URL for the E2B API\n    const baseUrl = process.env.NEXT_PUBLIC_APP_URL ||\n                    (process.env.VERCEL_URL ? `https://${process.env.VERCEL_URL}` : \"http://localhost:3000\");\n\n    // Call the E2B execute endpoint\n    const response = await fetch(`${baseUrl}${E2B_API_URL}`, {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n      },\n      body: JSON.stringify({\n        prompt,\n        outputFile: \"analysis.json\",\n        timeoutMs: 240000,\n      }),\n    });\n\n    if (!response.ok) {\n      const errorText = await response.text();\n      throw new Error(`E2B API call failed: ${response.status} ${errorText}`);\n    }\n\n    const result = await response.json();\n\n    if (!result.success) {\n      throw new Error(result.error || \"E2B execution failed\");\n    }\n\n    // Parse the JSON result\n    let analysisResult;\n\n    // Try to read from file content first\n    if (result.fileContent) {\n      try {\n        analysisResult = JSON.parse(result.fileContent);\n      } catch {\n        console.error(\"Failed to parse file content as JSON\");\n      }\n    }\n\n    // Try to extract JSON from stdout\n    if (!analysisResult) {\n      const jsonMatch = result.stdout?.match(/```json\\n([\\s\\S]*?)\\n```/) ||\n                        result.stdout?.match(/\\{[\\s\\S]*\"score\"[\\s\\S]*\"recommendations\"[\\s\\S]*\\}/);\n\n      if (jsonMatch) {\n        try {\n          const jsonStr = jsonMatch[1] || jsonMatch[0];\n          const start = jsonStr.indexOf('{');\n          const end = jsonStr.lastIndexOf('}') + 1;\n          if (start !== -1 && end > start) {\n            analysisResult = JSON.parse(jsonStr.substring(start, end));\n          }\n        } catch (e) {\n          console.error(\"Failed to parse analysis JSON:\", e);\n        }\n      }\n    }\n\n    // If we still don't have a result, create a default one\n    if (!analysisResult) {\n      analysisResult = {\n        score: 50,\n        missingDocuments: [],\n        outdatedDocuments: [],\n        inconsistencies: [],\n        recommendations: [\n          {\n            action: \"Review analysis output manually\",\n            priority: \"medium\",\n            reason: \"Automated parsing could not extract structured results\"\n          }\n        ],\n        stateSpecificNotes: [],\n        rawAnalysis: result.stdout,\n      };\n    }\n\n    return NextResponse.json({\n      success: true,\n      analysisResult,\n      stdout: result.stdout,\n    });\n\n  } catch (error) {\n    console.error(\"Gap analysis error:\", error);\n    return NextResponse.json(\n      {\n        success: false,\n        error: error instanceof Error ? error.message : \"Unknown error\"\n      },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":"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"}}]
}