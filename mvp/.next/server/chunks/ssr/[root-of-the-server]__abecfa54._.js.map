{"version":3,"sources":["../../../../node_modules/%40clerk/nextjs/src/server/keyless-custom-headers.ts","../../../../node_modules/%40clerk/nextjs/src/server/keyless-node.ts"],"sourcesContent":["'use server';\n\nimport { headers } from 'next/headers';\n\ninterface MetadataHeaders {\n  nodeVersion?: string;\n  nextVersion?: string;\n  npmConfigUserAgent?: string;\n  userAgent: string;\n  port?: string;\n  host: string;\n  xHost: string;\n  xPort: string;\n  xProtocol: string;\n  xClerkAuthStatus: string;\n  isCI: boolean;\n}\n\n/**\n * Collects metadata from the environment and request headers\n */\nexport async function collectKeylessMetadata(): Promise<MetadataHeaders> {\n  const headerStore = await headers();\n\n  return {\n    nodeVersion: process.version,\n    nextVersion: getNextVersion(),\n    npmConfigUserAgent: process.env.npm_config_user_agent, // eslint-disable-line\n    userAgent: headerStore.get('User-Agent') ?? 'unknown user-agent',\n    port: process.env.PORT, // eslint-disable-line\n    host: headerStore.get('host') ?? 'unknown host',\n    xPort: headerStore.get('x-forwarded-port') ?? 'unknown x-forwarded-port',\n    xHost: headerStore.get('x-forwarded-host') ?? 'unknown x-forwarded-host',\n    xProtocol: headerStore.get('x-forwarded-proto') ?? 'unknown x-forwarded-proto',\n    xClerkAuthStatus: headerStore.get('x-clerk-auth-status') ?? 'unknown x-clerk-auth-status',\n    isCI: detectCIEnvironment(),\n  };\n}\n\n// Common CI environment variables\nconst CI_ENV_VARS = [\n  'CI',\n  'CONTINUOUS_INTEGRATION',\n  'BUILD_NUMBER',\n  'BUILD_ID',\n  'BUILDKITE',\n  'CIRCLECI',\n  'GITHUB_ACTIONS',\n  'GITLAB_CI',\n  'JENKINS_URL',\n  'TRAVIS',\n  'APPVEYOR',\n  'WERCKER',\n  'DRONE',\n  'CODESHIP',\n  'SEMAPHORE',\n  'SHIPPABLE',\n  'TEAMCITY_VERSION',\n  'BAMBOO_BUILDKEY',\n  'GO_PIPELINE_NAME',\n  'TF_BUILD',\n  'SYSTEM_TEAMFOUNDATIONCOLLECTIONURI',\n  'BITBUCKET_BUILD_NUMBER',\n  'HEROKU_TEST_RUN_ID',\n  'VERCEL',\n  'NETLIFY',\n];\n\n/**\n * Detects if the application is running in a CI environment\n */\nfunction detectCIEnvironment(): boolean {\n  const ciIndicators = CI_ENV_VARS;\n\n  const falsyValues = new Set<string>(['', 'false', '0', 'no']);\n\n  return ciIndicators.some(indicator => {\n    const value = process.env[indicator];\n    if (value === undefined) {\n      return false;\n    }\n\n    const normalizedValue = value.trim().toLowerCase();\n    return !falsyValues.has(normalizedValue);\n  });\n}\n\n/**\n * Extracts Next.js version from process title\n */\nfunction getNextVersion(): string | undefined {\n  try {\n    return process.title ?? 'unknown-process-title'; // 'next-server (v15.4.5)'\n  } catch {\n    return undefined;\n  }\n}\n\n/**\n * Converts metadata to HTTP headers\n */\nexport async function formatMetadataHeaders(metadata: MetadataHeaders): Promise<Headers> {\n  const headers = new Headers();\n\n  if (metadata.nodeVersion) {\n    headers.set('Clerk-Node-Version', metadata.nodeVersion);\n  }\n\n  if (metadata.nextVersion) {\n    headers.set('Clerk-Next-Version', metadata.nextVersion);\n  }\n\n  if (metadata.npmConfigUserAgent) {\n    headers.set('Clerk-NPM-Config-User-Agent', metadata.npmConfigUserAgent);\n  }\n\n  if (metadata.userAgent) {\n    headers.set('Clerk-Client-User-Agent', metadata.userAgent);\n  }\n\n  if (metadata.port) {\n    headers.set('Clerk-Node-Port', metadata.port);\n  }\n\n  if (metadata.host) {\n    headers.set('Clerk-Client-Host', metadata.host);\n  }\n\n  if (metadata.xPort) {\n    headers.set('Clerk-X-Port', metadata.xPort);\n  }\n\n  if (metadata.xHost) {\n    headers.set('Clerk-X-Host', metadata.xHost);\n  }\n\n  if (metadata.xProtocol) {\n    headers.set('Clerk-X-Protocol', metadata.xProtocol);\n  }\n\n  if (metadata.xClerkAuthStatus) {\n    headers.set('Clerk-Auth-Status', metadata.xClerkAuthStatus);\n  }\n\n  if (metadata.isCI) {\n    headers.set('Clerk-Is-CI', 'true');\n  }\n\n  return headers;\n}\n","import type { AccountlessApplication } from '@clerk/backend';\n\nimport { createClerkClientWithOptions } from './createClerkClient';\nimport { nodeCwdOrThrow, nodeFsOrThrow, nodePathOrThrow } from './fs/utils';\nimport { collectKeylessMetadata, formatMetadataHeaders } from './keyless-custom-headers';\n\n/**\n * The Clerk-specific directory name.\n */\nconst CLERK_HIDDEN = '.clerk';\n\n/**\n * The Clerk-specific lock file that is used to mitigate multiple key creation.\n * This is automatically cleaned up.\n */\nconst CLERK_LOCK = 'clerk.lock';\n\n/**\n * The `.clerk/` directory is NOT safe to be committed as it may include sensitive information about a Clerk instance.\n * It may include an instance's secret key and the secret token for claiming that instance.\n */\nfunction updateGitignore() {\n  const { existsSync, writeFileSync, readFileSync, appendFileSync } = nodeFsOrThrow();\n\n  const path = nodePathOrThrow();\n  const cwd = nodeCwdOrThrow();\n  const gitignorePath = path.join(cwd(), '.gitignore');\n  if (!existsSync(gitignorePath)) {\n    writeFileSync(gitignorePath, '');\n  }\n\n  // Check if `.clerk/` entry exists in .gitignore\n  const gitignoreContent = readFileSync(gitignorePath, 'utf-8');\n  const COMMENT = `# clerk configuration (can include secrets)`;\n  if (!gitignoreContent.includes(CLERK_HIDDEN + '/')) {\n    appendFileSync(gitignorePath, `\\n${COMMENT}\\n/${CLERK_HIDDEN}/\\n`);\n  }\n}\n\nconst generatePath = (...slugs: string[]) => {\n  const path = nodePathOrThrow();\n  const cwd = nodeCwdOrThrow();\n  return path.join(cwd(), CLERK_HIDDEN, ...slugs);\n};\n\nconst _TEMP_DIR_NAME = '.tmp';\nconst getKeylessConfigurationPath = () => generatePath(_TEMP_DIR_NAME, 'keyless.json');\nconst getKeylessReadMePath = () => generatePath(_TEMP_DIR_NAME, 'README.md');\n\nlet isCreatingFile = false;\n\nexport function safeParseClerkFile(): AccountlessApplication | undefined {\n  const { readFileSync } = nodeFsOrThrow();\n  try {\n    const CONFIG_PATH = getKeylessConfigurationPath();\n    let fileAsString;\n    try {\n      fileAsString = readFileSync(CONFIG_PATH, { encoding: 'utf-8' }) || '{}';\n    } catch {\n      fileAsString = '{}';\n    }\n    return JSON.parse(fileAsString) as AccountlessApplication;\n  } catch {\n    return undefined;\n  }\n}\n\n/**\n * Using both an in-memory and file system lock seems to be the most effective solution.\n */\nconst lockFileWriting = () => {\n  const { writeFileSync } = nodeFsOrThrow();\n\n  isCreatingFile = true;\n\n  writeFileSync(\n    CLERK_LOCK,\n    // In the rare case, the file persists give the developer enough context.\n    'This file can be deleted. Please delete this file and refresh your application',\n    {\n      encoding: 'utf8',\n      mode: '0777',\n      flag: 'w',\n    },\n  );\n};\n\nconst unlockFileWriting = () => {\n  const { rmSync } = nodeFsOrThrow();\n\n  try {\n    rmSync(CLERK_LOCK, { force: true, recursive: true });\n  } catch {\n    // Simply ignore if the removal of the directory/file fails\n  }\n\n  isCreatingFile = false;\n};\n\nconst isFileWritingLocked = () => {\n  const { existsSync } = nodeFsOrThrow();\n  return isCreatingFile || existsSync(CLERK_LOCK);\n};\n\nasync function createOrReadKeyless(): Promise<AccountlessApplication | null> {\n  const { writeFileSync, mkdirSync } = nodeFsOrThrow();\n\n  /**\n   * If another request is already in the process of acquiring keys return early.\n   * Using both an in-memory and file system lock seems to be the most effective solution.\n   */\n  if (isFileWritingLocked()) {\n    return null;\n  }\n\n  lockFileWriting();\n\n  const CONFIG_PATH = getKeylessConfigurationPath();\n  const README_PATH = getKeylessReadMePath();\n\n  mkdirSync(generatePath(_TEMP_DIR_NAME), { recursive: true });\n  updateGitignore();\n\n  /**\n   * When the configuration file exists, always read the keys from the file\n   */\n  const envVarsMap = safeParseClerkFile();\n  if (envVarsMap?.publishableKey && envVarsMap?.secretKey) {\n    unlockFileWriting();\n\n    return envVarsMap;\n  }\n\n  /**\n   * At this step, it is safe to create new keys and store them.\n   */\n  const client = createClerkClientWithOptions({});\n\n  // Collect metadata\n  const keylessHeaders = await collectKeylessMetadata()\n    .then(formatMetadataHeaders)\n    .catch(() => new Headers());\n\n  const accountlessApplication = await client.__experimental_accountlessApplications\n    .createAccountlessApplication({ requestHeaders: keylessHeaders })\n    .catch(() => null);\n\n  if (accountlessApplication) {\n    writeFileSync(CONFIG_PATH, JSON.stringify(accountlessApplication), {\n      encoding: 'utf8',\n      mode: '0777',\n      flag: 'w',\n    });\n\n    // TODO-KEYLESS: Add link to official documentation.\n    const README_NOTIFICATION = `\n## DO NOT COMMIT\nThis directory is auto-generated from \\`@clerk/nextjs\\` because you are running in Keyless mode. Avoid committing the \\`.clerk/\\` directory as it includes the secret key of the unclaimed instance.\n  `;\n\n    writeFileSync(README_PATH, README_NOTIFICATION, {\n      encoding: 'utf8',\n      mode: '0777',\n      flag: 'w',\n    });\n  }\n  /**\n   * Clean up locks.\n   */\n  unlockFileWriting();\n\n  return accountlessApplication;\n}\n\nfunction removeKeyless() {\n  const { rmSync } = nodeFsOrThrow();\n\n  /**\n   * If another request is already in the process of acquiring keys return early.\n   * Using both an in-memory and file system lock seems to be the most effective solution.\n   */\n  if (isFileWritingLocked()) {\n    return undefined;\n  }\n\n  lockFileWriting();\n\n  try {\n    rmSync(generatePath(), { force: true, recursive: true });\n  } catch {\n    // Simply ignore if the removal of the directory/file fails\n  }\n\n  /**\n   * Clean up locks.\n   */\n  unlockFileWriting();\n}\n\nexport { createOrReadKeyless, removeKeyless };\n"],"names":["headers"],"mappings":"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"}